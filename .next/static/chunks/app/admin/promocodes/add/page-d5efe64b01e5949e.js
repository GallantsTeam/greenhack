(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4148],{5392:(e,t,r)=>{Promise.resolve().then(r.bind(r,97126))},32829:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(40157).A)("SquarePercent",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"M9 9h.01",key:"1q5me6"}],["path",{d:"M15 15h.01",key:"lqbp3k"}]])},76981:(e,t,r)=>{"use strict";r.d(t,{C1:()=>w,bL:()=>k});var a=r(12115),s=r(6101),l=r(46081),i=r(85185),n=r(5845),o=r(45503),d=r(11275),c=r(28905),u=r(63655),p=r(95155),m="Checkbox",[h,x]=(0,l.A)(m),[_,g]=h(m),v=a.forwardRef((e,t)=>{let{__scopeCheckbox:r,name:l,checked:o,defaultChecked:d,required:c,disabled:m,value:h="on",onCheckedChange:x,form:g,...v}=e,[f,j]=a.useState(null),k=(0,s.s)(t,e=>j(e)),w=a.useRef(!1),S=!f||g||!!f.closest("form"),[C=!1,E]=(0,n.i)({prop:o,defaultProp:d,onChange:x}),V=a.useRef(C);return a.useEffect(()=>{let e=null==f?void 0:f.form;if(e){let t=()=>E(V.current);return e.addEventListener("reset",t),()=>e.removeEventListener("reset",t)}},[f,E]),(0,p.jsxs)(_,{scope:r,state:C,disabled:m,children:[(0,p.jsx)(u.sG.button,{type:"button",role:"checkbox","aria-checked":y(C)?"mixed":C,"aria-required":c,"data-state":N(C),"data-disabled":m?"":void 0,disabled:m,value:h,...v,ref:k,onKeyDown:(0,i.m)(e.onKeyDown,e=>{"Enter"===e.key&&e.preventDefault()}),onClick:(0,i.m)(e.onClick,e=>{E(e=>!!y(e)||!e),S&&(w.current=e.isPropagationStopped(),w.current||e.stopPropagation())})}),S&&(0,p.jsx)(b,{control:f,bubbles:!w.current,name:l,value:h,checked:C,required:c,disabled:m,form:g,style:{transform:"translateX(-100%)"},defaultChecked:!y(d)&&d})]})});v.displayName=m;var f="CheckboxIndicator",j=a.forwardRef((e,t)=>{let{__scopeCheckbox:r,forceMount:a,...s}=e,l=g(f,r);return(0,p.jsx)(c.C,{present:a||y(l.state)||!0===l.state,children:(0,p.jsx)(u.sG.span,{"data-state":N(l.state),"data-disabled":l.disabled?"":void 0,...s,ref:t,style:{pointerEvents:"none",...e.style}})})});j.displayName=f;var b=e=>{let{control:t,checked:r,bubbles:s=!0,defaultChecked:l,...i}=e,n=a.useRef(null),c=(0,o.Z)(r),u=(0,d.X)(t);a.useEffect(()=>{let e=n.current,t=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"checked").set;if(c!==r&&t){let a=new Event("click",{bubbles:s});e.indeterminate=y(r),t.call(e,!y(r)&&r),e.dispatchEvent(a)}},[c,r,s]);let m=a.useRef(!y(r)&&r);return(0,p.jsx)("input",{type:"checkbox","aria-hidden":!0,defaultChecked:null!=l?l:m.current,...i,tabIndex:-1,ref:n,style:{...e.style,...u,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function y(e){return"indeterminate"===e}function N(e){return y(e)?"indeterminate":e?"checked":"unchecked"}var k=v,w=j},97126:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>b});var a=r(95155),s=r(12115),l=r(62177),i=r(90221),n=r(55594),o=r(30285),d=r(62523),c=r(85057),u=r(66695),p=r(59409),m=r(47262),h=r(87481),x=r(35695),_=r(32829),g=r(12543),v=r(51920),f=r(50172);let j=n.Ik({code:n.Yj().min(3,"Код должен быть не менее 3 символов.").max(50,"Код не должен превышать 50 символов.").regex(/^[A-Z0-9_-]+$/,"Код может содержать только заглавные латинские буквы, цифры, дефис и подчеркивание."),type:n.k5(["balance_gh","product"],{required_error:"Тип промокода обязателен."}),value_gh:n.au.number().min(.01,"Сумма GH должна быть больше 0.").optional().nullable(),related_product_id:n.Yj().optional().nullable(),product_pricing_option_id:n.au.number().optional().nullable(),max_uses:n.au.number().min(1,"Максимальное количество использований должно быть не менее 1.").default(1),expires_at:n.Yj().optional().nullable(),is_active:n.zM().default(!0)}).refine(e=>("balance_gh"!==e.type||null!==e.value_gh&&void 0!==e.value_gh&&!(e.value_gh<=0))&&("product"!==e.type||!!e.related_product_id&&null!==e.product_pricing_option_id&&void 0!==e.product_pricing_option_id),{message:"Для типа 'Баланс GH' нужна сумма > 0. Для 'Товар' нужны ID продукта и ID варианта цены.",path:["type"]});function b(){let{toast:e}=(0,h.dj)(),t=(0,x.useRouter)(),[r,n]=(0,s.useState)(!1),[b,y]=(0,s.useState)([]),[N,k]=(0,s.useState)([]),[w,S]=(0,s.useState)(!0),[C,E]=(0,s.useState)(!1),V=(0,l.mN)({resolver:(0,i.u)(j),defaultValues:{code:"",type:"balance_gh",value_gh:100,max_uses:1,is_active:!0,expires_at:null,related_product_id:null,product_pricing_option_id:null}}),I=V.watch("type"),F=V.watch("related_product_id"),L=(0,s.useCallback)(async()=>{S(!0);try{let e=await fetch("/api/admin/products");if(!e.ok)throw Error("Failed to fetch products");let t=await e.json();y(t)}catch(t){e({title:"Ошибка",description:"Не удалось загрузить список товаров.",variant:"destructive"})}finally{S(!1)}},[e]),P=(0,s.useCallback)(async t=>{if(!t){k([]);return}E(!0);try{let e=await fetch("/api/products/".concat(t));if(!e.ok)throw Error("Failed to fetch product pricing options.");let r=await e.json(),a=(r.pricing_options||[]).map(e=>({...e,product_name:r.name}));k(a),a.length>0?V.setValue("product_pricing_option_id",a[0].id,{shouldValidate:!0}):V.setValue("product_pricing_option_id",void 0,{shouldValidate:!0})}catch(t){e({title:"Ошибка",description:"Не удалось загрузить варианты цен для продукта.",variant:"destructive"}),k([])}finally{E(!1)}},[e,V]);(0,s.useEffect)(()=>{L()},[L]),(0,s.useEffect)(()=>{"product"===I&&F?P(F):(k([]),V.setValue("product_pricing_option_id",void 0))},[I,F,P,V]);let q=async r=>{n(!0);let a=null;if(r.expires_at)try{a=new Date(r.expires_at).toISOString()}catch(t){e({title:"Ошибка даты",description:"Неверный формат даты истечения.",variant:"destructive"}),n(!1);return}let s={...r,expires_at:a,value_gh:"balance_gh"===r.type?r.value_gh:null,related_product_id:"product"===r.type?r.related_product_id:null,product_pricing_option_id:"product"===r.type?r.product_pricing_option_id:null};try{let a=await fetch("/api/admin/promocodes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),l=await a.json();if(!a.ok)throw Error(l.message||"Failed to create promo code");e({title:"Успех!",description:'Промокод "'.concat(r.code,'" создан.')}),t.push("/admin/promocodes")}catch(t){e({title:"Ошибка создания",description:t.message,variant:"destructive"})}finally{n(!1)}};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("h1",{className:"text-2xl font-bold text-primary flex items-center",children:[(0,a.jsx)(_.A,{className:"mr-2 h-6 w-6"}),"Создать новый промокод"]}),(0,a.jsxs)(o.$,{onClick:()=>t.push("/admin/promocodes"),variant:"outline",className:"border-primary text-primary hover:bg-primary/10",children:[(0,a.jsx)(g.A,{className:"mr-2 h-4 w-4"}),"К списку промокодов"]})]}),(0,a.jsx)(u.Zp,{className:"shadow-lg",children:(0,a.jsx)(u.Wu,{className:"pt-6",children:(0,a.jsxs)("form",{onSubmit:V.handleSubmit(q),className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"code",className:"text-foreground",children:"Код промокода (уникальный)"}),(0,a.jsx)(d.p,{id:"code",...V.register("code"),placeholder:"NEWSITE2025",className:"mt-1 uppercase",disabled:r}),V.formState.errors.code&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:V.formState.errors.code.message})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"type",className:"text-foreground",children:"Тип промокода"}),(0,a.jsx)(l.xI,{control:V.control,name:"type",render:e=>{let{field:t}=e;return(0,a.jsxs)(p.l6,{onValueChange:e=>{t.onChange(e),"balance_gh"===e?(V.setValue("related_product_id",null),V.setValue("product_pricing_option_id",null)):V.setValue("value_gh",null)},defaultValue:t.value,disabled:r,children:[(0,a.jsx)(p.bq,{className:"w-full mt-1",children:(0,a.jsx)(p.yv,{placeholder:"Выберите тип"})}),(0,a.jsxs)(p.gC,{children:[(0,a.jsx)(p.eb,{value:"balance_gh",children:"Пополнение баланса GH"}),(0,a.jsx)(p.eb,{value:"product",children:"Выдача товара"})]})]})}}),V.formState.errors.type&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:V.formState.errors.type.message})]}),"balance_gh"===I&&(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"value_gh",className:"text-foreground",children:"Сумма пополнения (GH)"}),(0,a.jsx)(d.p,{id:"value_gh",type:"number",step:"0.01",...V.register("value_gh"),placeholder:"100.00",className:"mt-1",disabled:r}),V.formState.errors.value_gh&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:V.formState.errors.value_gh.message})]}),"product"===I&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"related_product_id",className:"text-foreground",children:"Товар"}),(0,a.jsx)(l.xI,{control:V.control,name:"related_product_id",render:e=>{let{field:t}=e;return(0,a.jsxs)(p.l6,{onValueChange:e=>{t.onChange(e),V.setValue("product_pricing_option_id",void 0)},value:t.value||"",disabled:r||w,children:[(0,a.jsx)(p.bq,{className:"w-full mt-1",children:(0,a.jsx)(p.yv,{placeholder:w?"Загрузка товаров...":"Выберите товар"})}),(0,a.jsx)(p.gC,{children:b.map(e=>(0,a.jsx)(p.eb,{value:e.id,children:e.name},e.id))})]})}}),V.formState.errors.related_product_id&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:V.formState.errors.related_product_id.message})]}),F&&(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"product_pricing_option_id",className:"text-foreground",children:"Вариант товара (срок/версия)"}),(0,a.jsx)(l.xI,{control:V.control,name:"product_pricing_option_id",render:e=>{var t;let{field:s}=e;return(0,a.jsxs)(p.l6,{onValueChange:s.onChange,value:(null===(t=s.value)||void 0===t?void 0:t.toString())||"",disabled:r||C||0===N.length,children:[(0,a.jsx)(p.bq,{className:"w-full mt-1",children:(0,a.jsx)(p.yv,{placeholder:C?"Загрузка опций...":0===N.length?"Нет опций для товара":"Выберите вариант"})}),(0,a.jsx)(p.gC,{children:N.map(e=>(0,a.jsxs)(p.eb,{value:e.id.toString(),children:[e.duration_days," дн. - ",e.price_rub,"₽ / ",e.price_gh,"GH ",e.is_pvp?"(PVP)":"(PVE)"]},e.id))})]})}}),V.formState.errors.product_pricing_option_id&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:V.formState.errors.product_pricing_option_id.message})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"max_uses",className:"text-foreground",children:"Максимальное количество использований"}),(0,a.jsx)(d.p,{id:"max_uses",type:"number",...V.register("max_uses"),placeholder:"100",className:"mt-1",disabled:r}),V.formState.errors.max_uses&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:V.formState.errors.max_uses.message})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"expires_at",className:"text-foreground",children:"Дата и время истечения (необязательно)"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(l.xI,{control:V.control,name:"expires_at",render:e=>{let{field:t}=e;return(0,a.jsx)(d.p,{id:"expires_at",type:"datetime-local",value:t.value?t.value.substring(0,16):"",onChange:e=>t.onChange(e.target.value?new Date(e.target.value).toISOString():null),className:"mt-1",disabled:r})}}),(0,a.jsx)(v.A,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none"})]}),V.formState.errors.expires_at&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:V.formState.errors.expires_at.message})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(l.xI,{control:V.control,name:"is_active",render:e=>{let{field:t}=e;return(0,a.jsx)(m.S,{id:"is_active",checked:t.value,onCheckedChange:t.onChange,disabled:r})}}),(0,a.jsx)(c.Label,{htmlFor:"is_active",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-foreground",children:"Промокод активен"})]}),(0,a.jsx)("div",{className:"flex justify-end pt-4",children:(0,a.jsxs)(o.$,{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground",disabled:r||w,children:[r?(0,a.jsx)(f.A,{className:"mr-2 h-4 w-4 animate-spin"}):null,r?"Создание...":"Создать промокод"]})})]})})})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[4277,7576,5521,5756,9205,8897,1153,8441,1684,7358],()=>t(5392)),_N_E=e.O()}]);