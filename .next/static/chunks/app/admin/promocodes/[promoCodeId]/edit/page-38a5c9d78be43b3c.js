(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3417],{60023:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>y});var a=r(95155),s=r(12115),i=r(62177),l=r(90221),o=r(55594),d=r(30285),n=r(62523),c=r(85057),u=r(66695),p=r(59409),m=r(47262),_=r(87481),h=r(35695),x=r(50172),g=r(18763),v=r(12543),j=r(51920),f=r(28184);let b=o.Ik({type:o.k5(["balance_gh","product"],{required_error:"Тип промокода обязателен."}),value_gh:o.au.number().min(.01,"Сумма GH должна быть больше 0.").optional().nullable(),related_product_id:o.Yj().optional().nullable(),product_pricing_option_id:o.au.number().optional().nullable(),max_uses:o.au.number().min(1,"Максимальное количество использований должно быть не менее 1."),expires_at:o.Yj().optional().nullable(),is_active:o.zM().default(!0)}).refine(e=>("balance_gh"!==e.type||null!==e.value_gh&&void 0!==e.value_gh&&!(e.value_gh<=0))&&("product"!==e.type||!!e.related_product_id&&null!==e.product_pricing_option_id&&void 0!==e.product_pricing_option_id),{message:"Для типа 'Баланс GH' нужна сумма > 0. Для 'Товар' нужны ID продукта и ID варианта цены.",path:["type"]});function y(){let{toast:e}=(0,_.dj)(),t=(0,h.useRouter)(),r=(0,h.useParams)().promoCodeId,[o,y]=(0,s.useState)(!1),[N,w]=(0,s.useState)(!0),[S,C]=(0,s.useState)([]),[V,k]=(0,s.useState)([]),[F,E]=(0,s.useState)(!0),[I,L]=(0,s.useState)(!1),[H,P]=(0,s.useState)(""),D=(0,i.mN)({resolver:(0,l.u)(b),defaultValues:{type:"balance_gh",max_uses:1,is_active:!0}}),G=D.watch("type"),A=D.watch("related_product_id"),O=(0,s.useCallback)(async r=>{w(!0);try{var a,s,i;let e;let t=await fetch("/api/admin/promocodes/".concat(r));if(!t.ok){let e=await t.json().catch(()=>({message:"Failed to fetch promo code data"}));throw Error(e.message)}let l=await t.json();if(l.expires_at)try{e=(0,f.GP)(new Date(l.expires_at),"yyyy-MM-dd'T'HH:mm")}catch(e){console.warn("Error formatting expires_at from DB:",l.expires_at,e)}P(l.code),D.reset({type:l.type,value_gh:null!==(a=l.value_gh)&&void 0!==a?a:null,related_product_id:null!==(s=l.related_product_id)&&void 0!==s?s:null,product_pricing_option_id:null!==(i=l.product_pricing_option_id)&&void 0!==i?i:null,max_uses:l.max_uses,expires_at:e||null,is_active:l.is_active}),"product"===l.type&&l.related_product_id&&await T(l.related_product_id,l.product_pricing_option_id||void 0)}catch(r){e({title:"Ошибка",description:"Не удалось загрузить данные промокода: ".concat(r.message),variant:"destructive"}),t.push("/admin/promocodes")}finally{w(!1)}},[e,D,t]),q=(0,s.useCallback)(async()=>{E(!0);try{let e=await fetch("/api/admin/products");if(!e.ok)throw Error("Failed to fetch products");let t=await e.json();C(t)}catch(t){e({title:"Ошибка",description:"Не удалось загрузить список товаров.",variant:"destructive"})}finally{E(!1)}},[e]),T=(0,s.useCallback)(async(t,r)=>{if(!t){k([]);return}L(!0);try{let e=await fetch("/api/products/".concat(t));if(!e.ok)throw Error("Failed to fetch product pricing options.");let a=await e.json(),s=(a.pricing_options||[]).map(e=>({...e,product_name:a.name}));k(s),r?D.setValue("product_pricing_option_id",r,{shouldValidate:!0}):s.length>0&&!D.getValues("product_pricing_option_id")&&D.setValue("product_pricing_option_id",s[0].id,{shouldValidate:!0})}catch(t){e({title:"Ошибка",description:"Не удалось загрузить варианты цен для продукта.",variant:"destructive"}),k([])}finally{L(!1)}},[e,D]);(0,s.useEffect)(()=>{q(),r&&O(r)},[q,O,r]),(0,s.useEffect)(()=>{"product"===G&&A?D.getValues("product_pricing_option_id")&&V.find(e=>e.id===D.getValues("product_pricing_option_id"))||T(A):"product"!==G&&(k([]),D.setValue("product_pricing_option_id",void 0))},[G,A,T,D,V]);let M=async a=>{if(!r)return;y(!0);let s=null;if(a.expires_at)try{s=new Date(a.expires_at).toISOString().slice(0,19).replace("T"," ")}catch(t){e({title:"Ошибка даты",description:"Неверный формат даты истечения.",variant:"destructive"}),y(!1);return}let i={...a,expires_at:s,value_gh:"balance_gh"===a.type?a.value_gh:null,related_product_id:"product"===a.type?a.related_product_id:null,product_pricing_option_id:"product"===a.type?a.product_pricing_option_id:null};try{let a=await fetch("/api/admin/promocodes/".concat(r),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),s=await a.json();if(!a.ok)throw Error(s.message||"Failed to update promo code");e({title:"Успех!",description:'Промокод "'.concat(H,'" обновлен.')}),t.push("/admin/promocodes")}catch(t){e({title:"Ошибка обновления",description:t.message,variant:"destructive"})}finally{y(!1)}};return N?(0,a.jsxs)("div",{className:"flex items-center justify-center h-full",children:[(0,a.jsx)(x.A,{className:"h-12 w-12 animate-spin text-primary"}),(0,a.jsx)("p",{className:"ml-3 text-muted-foreground",children:"Загрузка данных промокода..."})]}):(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("h1",{className:"text-2xl font-bold text-primary flex items-center",children:[(0,a.jsx)(g.A,{className:"mr-2 h-6 w-6"}),"Редактировать промокод: ",(0,a.jsx)("span",{className:"font-mono ml-2 bg-muted/80 px-2 py-0.5 rounded",children:H})]}),(0,a.jsxs)(d.$,{onClick:()=>t.push("/admin/promocodes"),variant:"outline",className:"border-primary text-primary hover:bg-primary/10",children:[(0,a.jsx)(v.A,{className:"mr-2 h-4 w-4"}),"К списку промокодов"]})]}),(0,a.jsx)(u.Zp,{className:"shadow-lg",children:(0,a.jsx)(u.Wu,{className:"pt-6",children:(0,a.jsxs)("form",{onSubmit:D.handleSubmit(M),className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"code",className:"text-foreground",children:"Код промокода (нередактируемый)"}),(0,a.jsx)(n.p,{id:"code",value:H,className:"mt-1 bg-muted",disabled:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"type",className:"text-foreground",children:"Тип промокода"}),(0,a.jsx)(i.xI,{control:D.control,name:"type",render:e=>{let{field:t}=e;return(0,a.jsxs)(p.l6,{onValueChange:e=>{t.onChange(e),"balance_gh"===e?(D.setValue("related_product_id",null),D.setValue("product_pricing_option_id",null)):D.setValue("value_gh",null)},value:t.value,disabled:o,children:[(0,a.jsx)(p.bq,{className:"w-full mt-1",children:(0,a.jsx)(p.yv,{placeholder:"Выберите тип"})}),(0,a.jsxs)(p.gC,{children:[(0,a.jsx)(p.eb,{value:"balance_gh",children:"Пополнение баланса GH"}),(0,a.jsx)(p.eb,{value:"product",children:"Выдача товара"})]})]})}}),D.formState.errors.type&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:D.formState.errors.type.message})]}),"balance_gh"===G&&(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"value_gh",className:"text-foreground",children:"Сумма пополнения (GH)"}),(0,a.jsx)(n.p,{id:"value_gh",type:"number",step:"0.01",...D.register("value_gh"),placeholder:"100.00",className:"mt-1",disabled:o}),D.formState.errors.value_gh&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:D.formState.errors.value_gh.message})]}),"product"===G&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"related_product_id",className:"text-foreground",children:"Товар"}),(0,a.jsx)(i.xI,{control:D.control,name:"related_product_id",render:e=>{let{field:t}=e;return(0,a.jsxs)(p.l6,{onValueChange:e=>{t.onChange(e),D.setValue("product_pricing_option_id",void 0,{shouldValidate:!0})},value:t.value||"",disabled:o||F,children:[(0,a.jsx)(p.bq,{className:"w-full mt-1",children:(0,a.jsx)(p.yv,{placeholder:F?"Загрузка товаров...":"Выберите товар"})}),(0,a.jsx)(p.gC,{children:S.map(e=>(0,a.jsx)(p.eb,{value:e.id,children:e.name},e.id))})]})}}),D.formState.errors.related_product_id&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:D.formState.errors.related_product_id.message})]}),A&&(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"product_pricing_option_id",className:"text-foreground",children:"Вариант товара (срок/версия)"}),(0,a.jsx)(i.xI,{control:D.control,name:"product_pricing_option_id",render:e=>{var t;let{field:r}=e;return(0,a.jsxs)(p.l6,{onValueChange:r.onChange,value:(null===(t=r.value)||void 0===t?void 0:t.toString())||"",disabled:o||I||0===V.length,children:[(0,a.jsx)(p.bq,{className:"w-full mt-1",children:(0,a.jsx)(p.yv,{placeholder:I?"Загрузка опций...":0===V.length?"Нет опций для товара":"Выберите вариант"})}),(0,a.jsx)(p.gC,{children:V.map(e=>(0,a.jsxs)(p.eb,{value:e.id.toString(),children:[e.duration_days," дн. - ",e.price_rub,"₽ / ",e.price_gh,"GH ",e.is_pvp?"(PVP)":"(PVE)"]},e.id))})]})}}),D.formState.errors.product_pricing_option_id&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:D.formState.errors.product_pricing_option_id.message})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"max_uses",className:"text-foreground",children:"Максимальное количество использований"}),(0,a.jsx)(n.p,{id:"max_uses",type:"number",...D.register("max_uses"),className:"mt-1",disabled:o}),D.formState.errors.max_uses&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:D.formState.errors.max_uses.message})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(c.Label,{htmlFor:"expires_at",className:"text-foreground",children:"Дата и время истечения (необязательно)"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(i.xI,{control:D.control,name:"expires_at",render:e=>{let{field:t}=e;return(0,a.jsx)(n.p,{id:"expires_at",type:"datetime-local",value:t.value?t.value.substring(0,16):"",onChange:e=>t.onChange(e.target.value?new Date(e.target.value).toISOString():null),className:"mt-1",disabled:o})}}),(0,a.jsx)(j.A,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none"})]}),D.formState.errors.expires_at&&(0,a.jsx)("p",{className:"text-sm text-destructive mt-1",children:D.formState.errors.expires_at.message})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(i.xI,{control:D.control,name:"is_active",render:e=>{let{field:t}=e;return(0,a.jsx)(m.S,{id:"is_active",checked:t.value,onCheckedChange:t.onChange,disabled:o})}}),(0,a.jsx)(c.Label,{htmlFor:"is_active",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-foreground",children:"Промокод активен"})]}),(0,a.jsx)("div",{className:"flex justify-end pt-4",children:(0,a.jsxs)(d.$,{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground",disabled:o||F||N,children:[o?(0,a.jsx)(x.A,{className:"mr-2 h-4 w-4 animate-spin"}):null,o?"Сохранение...":"Сохранить изменения"]})})]})})})]})}},87497:(e,t,r)=>{Promise.resolve().then(r.bind(r,60023))}},e=>{var t=t=>e(e.s=t);e.O(0,[4277,7576,5521,5756,9205,8897,7336,1153,8441,1684,7358],()=>t(87497)),_N_E=e.O()}]);