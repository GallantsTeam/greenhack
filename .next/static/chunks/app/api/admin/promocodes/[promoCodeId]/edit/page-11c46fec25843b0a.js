(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1294],{45992:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>y});var r=a(95155),s=a(12115),i=a(62177),l=a(90221),o=a(55594),d=a(30285),n=a(62523),c=a(85057),u=a(66695),p=a(59409),m=a(47262),_=a(87481),h=a(35695),x=a(50172),g=a(18763),v=a(12543),j=a(51920),f=a(28184);let b=o.Ik({type:o.k5(["balance_gh","product"],{required_error:"Тип промокода обязателен."}),value_gh:o.au.number().min(.01,"Сумма GH должна быть больше 0.").optional().nullable(),related_product_id:o.Yj().optional().nullable(),product_pricing_option_id:o.au.number().optional().nullable(),max_uses:o.au.number().min(1,"Максимальное количество использований должно быть не менее 1."),expires_at:o.Yj().optional().nullable(),is_active:o.zM().default(!0)}).refine(e=>("balance_gh"!==e.type||null!==e.value_gh&&void 0!==e.value_gh&&!(e.value_gh<=0))&&("product"!==e.type||!!e.related_product_id&&null!==e.product_pricing_option_id&&void 0!==e.product_pricing_option_id),{message:"Для типа 'Баланс GH' нужна сумма > 0. Для 'Товар' нужны ID продукта и ID варианта цены.",path:["type"]});function y(){let{toast:e}=(0,_.dj)(),t=(0,h.useRouter)(),a=(0,h.useParams)().promoCodeId,[o,y]=(0,s.useState)(!1),[N,w]=(0,s.useState)(!0),[S,C]=(0,s.useState)([]),[V,k]=(0,s.useState)([]),[F,E]=(0,s.useState)(!0),[I,L]=(0,s.useState)(!1),[H,D]=(0,s.useState)(""),G=(0,i.mN)({resolver:(0,l.u)(b),defaultValues:{type:"balance_gh",max_uses:1,is_active:!0}}),A=G.watch("type"),O=G.watch("related_product_id"),T=(0,s.useCallback)(async(t,a)=>{if(!t){k([]),G.setValue("product_pricing_option_id",void 0,{shouldValidate:!1});return}L(!0);try{let e=await fetch("/api/products/".concat(t));if(!e.ok)throw Error("Failed to fetch product pricing options.");let r=await e.json(),s=(r.pricing_options||[]).map(e=>({...e,product_name:r.name,mode_label:e.mode_label}));k(s),a&&s.some(e=>e.id===a)?G.setValue("product_pricing_option_id",a,{shouldValidate:!0}):s.length>0?G.setValue("product_pricing_option_id",s[0].id,{shouldValidate:!0}):G.setValue("product_pricing_option_id",void 0,{shouldValidate:!1})}catch(t){e({title:"Ошибка",description:"Не удалось загрузить варианты цен для продукта.",variant:"destructive"}),k([]),G.setValue("product_pricing_option_id",void 0,{shouldValidate:!1})}finally{L(!1)}},[e,G]),q=(0,s.useCallback)(async a=>{w(!0);try{var r,s,i;let e;let t=await fetch("/api/admin/promocodes/".concat(a));if(!t.ok){let e=await t.json().catch(()=>({message:"Failed to fetch promo code data"}));throw Error(e.message)}let l=await t.json();if(l.expires_at)try{e=(0,f.GP)(new Date(l.expires_at),"yyyy-MM-dd'T'HH:mm")}catch(e){console.warn("Error formatting expires_at from DB:",l.expires_at,e)}D(l.code),G.reset({type:l.type,value_gh:null!==(r=l.value_gh)&&void 0!==r?r:null,related_product_id:null!==(s=l.related_product_id)&&void 0!==s?s:null,product_pricing_option_id:null!==(i=l.product_pricing_option_id)&&void 0!==i?i:null,max_uses:l.max_uses,expires_at:e||null,is_active:l.is_active}),"product"===l.type&&l.related_product_id}catch(a){e({title:"Ошибка",description:"Не удалось загрузить данные промокода: ".concat(a.message),variant:"destructive"}),t.push("/admin/promocodes")}finally{w(!1)}},[e,G,t]),P=(0,s.useCallback)(async()=>{E(!0);try{let e=await fetch("/api/admin/products");if(!e.ok)throw Error("Failed to fetch products");let t=await e.json();C(t)}catch(t){e({title:"Ошибка",description:"Не удалось загрузить список товаров.",variant:"destructive"})}finally{E(!1)}},[e]);(0,s.useEffect)(()=>{P(),a&&q(a)},[P,q,a]),(0,s.useEffect)(()=>{let e=G.getValues("product_pricing_option_id");"product"===A&&O?T(O,e||void 0):"product"!==A&&(k([]),G.setValue("product_pricing_option_id",void 0,{shouldValidate:!1}))},[A,O]);let M=async r=>{if(!a)return;y(!0);let s=null;if(r.expires_at)try{let e=new Date(r.expires_at);if(isNaN(e.getTime()))throw Error("Invalid date format from input");s=e.toISOString().slice(0,19).replace("T"," ")}catch(t){console.error("Error formatting expires_at on submit:",r.expires_at,t),e({title:"Ошибка даты",description:"Неверный формат даты истечения.",variant:"destructive"}),y(!1);return}let i={...r,expires_at:s,value_gh:"balance_gh"===r.type?r.value_gh:null,related_product_id:"product"===r.type?r.related_product_id:null,product_pricing_option_id:"product"===r.type?r.product_pricing_option_id:null};try{let r=await fetch("/api/admin/promocodes/".concat(a),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),s=await r.json();if(!r.ok)throw Error(s.message||"Failed to update promo code");e({title:"Успех!",description:'Промокод "'.concat(H,'" обновлен.')}),t.push("/admin/promocodes")}catch(t){e({title:"Ошибка обновления",description:t.message,variant:"destructive"})}finally{y(!1)}};return N?(0,r.jsxs)("div",{className:"flex items-center justify-center h-full",children:[(0,r.jsx)(x.A,{className:"h-12 w-12 animate-spin text-primary"}),(0,r.jsx)("p",{className:"ml-3 text-muted-foreground",children:"Загрузка данных промокода..."})]}):(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("h1",{className:"text-2xl font-bold text-primary flex items-center",children:[(0,r.jsx)(g.A,{className:"mr-2 h-6 w-6"}),"Редактировать промокод: ",(0,r.jsx)("span",{className:"font-mono ml-2 bg-muted/80 px-2 py-0.5 rounded",children:H})]}),(0,r.jsxs)(d.$,{onClick:()=>t.push("/admin/promocodes"),variant:"outline",className:"border-primary text-primary hover:bg-primary/10",children:[(0,r.jsx)(v.A,{className:"mr-2 h-4 w-4"}),"К списку промокодов"]})]}),(0,r.jsx)(u.Zp,{className:"shadow-lg",children:(0,r.jsx)(u.Wu,{className:"pt-6",children:(0,r.jsxs)("form",{onSubmit:G.handleSubmit(M),className:"space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(c.Label,{htmlFor:"code",className:"text-foreground",children:"Код промокода (нередактируемый)"}),(0,r.jsx)(n.p,{id:"code",value:H,className:"mt-1 bg-muted",disabled:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(c.Label,{htmlFor:"type",className:"text-foreground",children:"Тип промокода"}),(0,r.jsx)(i.xI,{control:G.control,name:"type",render:e=>{let{field:t}=e;return(0,r.jsxs)(p.l6,{onValueChange:e=>{t.onChange(e),"balance_gh"===e?(G.setValue("related_product_id",null),G.setValue("product_pricing_option_id",null)):G.setValue("value_gh",null)},value:t.value,disabled:o,children:[(0,r.jsx)(p.bq,{className:"w-full mt-1",children:(0,r.jsx)(p.yv,{placeholder:"Выберите тип"})}),(0,r.jsxs)(p.gC,{children:[(0,r.jsx)(p.eb,{value:"balance_gh",children:"Пополнение баланса GH"}),(0,r.jsx)(p.eb,{value:"product",children:"Выдача товара"})]})]})}}),G.formState.errors.type&&(0,r.jsx)("p",{className:"text-sm text-destructive mt-1",children:G.formState.errors.type.message})]}),"balance_gh"===A&&(0,r.jsxs)("div",{children:[(0,r.jsx)(c.Label,{htmlFor:"value_gh",className:"text-foreground",children:"Сумма пополнения (GH)"}),(0,r.jsx)(n.p,{id:"value_gh",type:"number",step:"0.01",...G.register("value_gh"),placeholder:"100.00",className:"mt-1",disabled:o}),G.formState.errors.value_gh&&(0,r.jsx)("p",{className:"text-sm text-destructive mt-1",children:G.formState.errors.value_gh.message})]}),"product"===A&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(c.Label,{htmlFor:"related_product_id",className:"text-foreground",children:"Товар"}),(0,r.jsx)(i.xI,{control:G.control,name:"related_product_id",render:e=>{let{field:t}=e;return(0,r.jsxs)(p.l6,{onValueChange:e=>{t.onChange(e),G.setValue("product_pricing_option_id",void 0,{shouldValidate:!0})},value:t.value||"",disabled:o||F,children:[(0,r.jsx)(p.bq,{className:"w-full mt-1",children:(0,r.jsx)(p.yv,{placeholder:F?"Загрузка товаров...":"Выберите товар"})}),(0,r.jsx)(p.gC,{children:S.map(e=>(0,r.jsx)(p.eb,{value:e.id,children:e.name},e.id))})]})}}),G.formState.errors.related_product_id&&(0,r.jsx)("p",{className:"text-sm text-destructive mt-1",children:G.formState.errors.related_product_id.message})]}),O&&(0,r.jsxs)("div",{children:[(0,r.jsx)(c.Label,{htmlFor:"product_pricing_option_id",className:"text-foreground",children:"Вариант товара (срок/режим)"}),(0,r.jsx)(i.xI,{control:G.control,name:"product_pricing_option_id",render:e=>{var t;let{field:a}=e;return(0,r.jsxs)(p.l6,{onValueChange:e=>a.onChange(Number(e)),value:(null===(t=a.value)||void 0===t?void 0:t.toString())||"",disabled:o||I||0===V.length,children:[(0,r.jsx)(p.bq,{className:"w-full mt-1",children:(0,r.jsx)(p.yv,{placeholder:I?"Загрузка опций...":0===V.length?"Нет опций для товара":"Выберите вариант"})}),(0,r.jsx)(p.gC,{children:V.map(e=>(0,r.jsxs)(p.eb,{value:e.id.toString(),children:[e.duration_days," дн. ",e.mode_label?"(".concat(e.mode_label,")"):""," - ",e.price_rub,"₽ / ",e.price_gh,"GH"]},e.id))})]})}}),G.formState.errors.product_pricing_option_id&&(0,r.jsx)("p",{className:"text-sm text-destructive mt-1",children:G.formState.errors.product_pricing_option_id.message})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(c.Label,{htmlFor:"max_uses",className:"text-foreground",children:"Максимальное количество использований"}),(0,r.jsx)(n.p,{id:"max_uses",type:"number",...G.register("max_uses"),className:"mt-1",disabled:o}),G.formState.errors.max_uses&&(0,r.jsx)("p",{className:"text-sm text-destructive mt-1",children:G.formState.errors.max_uses.message})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(c.Label,{htmlFor:"expires_at",className:"text-foreground",children:"Дата и время истечения (необязательно)"}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)(i.xI,{control:G.control,name:"expires_at",render:e=>{let{field:t}=e;return(0,r.jsx)(n.p,{id:"expires_at",type:"datetime-local",value:t.value?t.value.substring(0,16):"",onChange:e=>t.onChange(e.target.value?new Date(e.target.value).toISOString():null),className:"mt-1",disabled:o})}}),(0,r.jsx)(j.A,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none"})]}),G.formState.errors.expires_at&&(0,r.jsx)("p",{className:"text-sm text-destructive mt-1",children:G.formState.errors.expires_at.message})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)(i.xI,{control:G.control,name:"is_active",render:e=>{let{field:t}=e;return(0,r.jsx)(m.S,{id:"is_active",checked:t.value,onCheckedChange:t.onChange,disabled:o})}}),(0,r.jsx)(c.Label,{htmlFor:"is_active",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-foreground",children:"Промокод активен"})]}),(0,r.jsx)("div",{className:"flex justify-end pt-4",children:(0,r.jsxs)(d.$,{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground",disabled:o||F||N,children:[o?(0,r.jsx)(x.A,{className:"mr-2 h-4 w-4 animate-spin"}):null,o?"Сохранение...":"Сохранить изменения"]})})]})})})]})}},97806:(e,t,a)=>{Promise.resolve().then(a.bind(a,45992))}},e=>{var t=t=>e(e.s=t);e.O(0,[4277,7576,5521,5756,9205,8897,7336,1153,8441,1684,7358],()=>t(97806)),_N_E=e.O()}]);