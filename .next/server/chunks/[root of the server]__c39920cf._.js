module.exports = {

"[project]/.next-internal/server/app/api/auth/register/route/actions.js [app-rsc] (server actions loader, ecmascript)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route.runtime.dev.js [external] (next/dist/compiled/next-server/app-route.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/@opentelemetry/api [external] (@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@opentelemetry/api", () => require("@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page.runtime.dev.js [external] (next/dist/compiled/next-server/app-page.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/process [external] (process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[externals]/timers [external] (timers, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("timers", () => require("timers"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/string_decoder [external] (string_decoder, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("string_decoder", () => require("string_decoder"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[project]/src/lib/mysql.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
/* __next_internal_action_entry_do_not_use__ {"6058d2186d06199210990ee590d0261587c858a217":"query"} */ __turbopack_context__.s({
    "query": (()=>query)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$app$2d$render$2f$encryption$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/app-render/encryption.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/mysql2/promise.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-route] (ecmascript)");
;
;
;
const connectionConfig = {
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
    connectionLimit: 10,
    namedPlaceholders: true
};
let pool = null;
function getPool() {
    if (!pool) {
        if (!process.env.DB_HOST || !process.env.DB_USER || !process.env.DB_NAME) {
            console.error("Database environment variables DB_HOST, DB_USER, or DB_NAME are not set.");
            throw new Error("Database environment variables are not fully set. Please check your .env.local file.");
        }
        try {
            pool = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createPool(connectionConfig);
            console.log("MySQL connection pool created successfully.");
            // Test the pool by getting a connection (optional, but good for early feedback)
            pool.getConnection().then((connection)=>{
                console.log("Successfully connected to database via pool.");
                connection.release();
            }).catch((err)=>{
                console.error("Failed to get a connection from pool on startup:", err);
            // Depending on severity, you might want to invalidate the pool or exit
            // For now, we'll let further queries fail if the pool is truly unusable.
            });
        } catch (error) {
            console.error("Failed to create MySQL connection pool:", error);
            // Ensure pool remains null if creation fails
            pool = null;
            throw new Error("Database connection pool could not be created.");
        }
    }
    return pool;
}
async function /*#__TURBOPACK_DISABLE_EXPORT_MERGING__*/ query(sql, params) {
    const currentPool = getPool(); // This will throw if pool cannot be initialized
    let connection;
    try {
        connection = await currentPool.getConnection();
        console.log(`Executing SQL: ${sql} with params: ${params ? JSON.stringify(params) : 'No params'}`);
        const [results] = await connection.execute(sql, params);
        return results;
    } catch (error) {
        console.error('Database query error:', error.message, error.code, error.sqlMessage, error.sql);
        throw new Error(`Database query failed: ${error.message}`);
    } finally{
        if (connection) {
            connection.release();
        }
    }
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    query
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(query, "6058d2186d06199210990ee590d0261587c858a217", null);
}}),
"[externals]/fs [external] (fs, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/dns [external] (dns, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("dns", () => require("dns"));

module.exports = mod;
}}),
"[externals]/os [external] (os, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}}),
"[externals]/path [external] (path, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}}),
"[externals]/child_process [external] (child_process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}}),
"[project]/src/lib/email.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
// src/lib/email.ts
__turbopack_context__.s({
    "sendBalanceUpdateEmail": (()=>sendBalanceUpdateEmail),
    "sendEmail": (()=>sendEmail),
    "sendPurchaseConfirmationEmail": (()=>sendPurchaseConfirmationEmail),
    "sendRegistrationWelcomeEmail": (()=>sendRegistrationWelcomeEmail)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$nodemailer$2f$lib$2f$nodemailer$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/nodemailer/lib/nodemailer.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/mysql.ts [app-route] (ecmascript)");
;
;
const SETTINGS_ROW_ID = 1;
async function getSmtpSettings() {
    try {
        const results = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT * FROM site_smtp_settings WHERE id = ? LIMIT 1', [
            SETTINGS_ROW_ID
        ]);
        if (results.length > 0) {
            return results[0];
        }
        return null;
    } catch (error) {
        console.error("Error fetching SMTP settings for email:", error);
        return null;
    }
}
async function getNotificationSettings() {
    try {
        const results = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT * FROM site_notification_settings WHERE id = ? LIMIT 1', [
            SETTINGS_ROW_ID
        ]);
        if (results.length > 0) {
            const settings = results[0];
            return {
                id: settings.id,
                notify_on_registration: Boolean(settings.notify_on_registration),
                notify_on_balance_deposit: Boolean(settings.notify_on_balance_deposit),
                notify_on_product_purchase: Boolean(settings.notify_on_product_purchase),
                notify_on_support_reply: Boolean(settings.notify_on_support_reply),
                notify_on_software_activation: Boolean(settings.notify_on_software_activation),
                notify_on_license_expiry_soon: Boolean(settings.notify_on_license_expiry_soon),
                notify_on_promotions: Boolean(settings.notify_on_promotions),
                updated_at: settings.updated_at
            };
        }
        return null;
    } catch (error) {
        console.error("Error fetching notification settings for email:", error);
        return null;
    }
}
async function sendEmail(options) {
    const smtpConfig = await getSmtpSettings();
    if (!smtpConfig || !smtpConfig.smtp_host || !smtpConfig.smtp_port || !smtpConfig.from_email) {
        console.error("Email Service: SMTP settings are incomplete or not found.");
        return {
            success: false,
            message: "SMTP settings are incomplete."
        };
    }
    const transporterOptions = {
        host: smtpConfig.smtp_host,
        port: Number(smtpConfig.smtp_port),
        secure: Number(smtpConfig.smtp_port) === 465 || smtpConfig.smtp_encryption === 'ssl',
        auth: smtpConfig.smtp_username && smtpConfig.smtp_password ? {
            user: smtpConfig.smtp_username,
            pass: smtpConfig.smtp_password
        } : undefined
    };
    if (smtpConfig.smtp_encryption === 'tls' && Number(smtpConfig.smtp_port) !== 465) {
        transporterOptions.secure = false;
        transporterOptions.requireTLS = true;
    } else if (smtpConfig.smtp_encryption === 'none' && Number(smtpConfig.smtp_port) !== 465) {
        transporterOptions.secure = false;
        transporterOptions.ignoreTLS = true;
    }
    const transporter = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$nodemailer$2f$lib$2f$nodemailer$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createTransport(transporterOptions);
    try {
        await transporter.verify(); // Verify connection configuration
        console.log(`Email Service: Sending email to ${options.to} with subject "${options.subject}"`);
        await transporter.sendMail({
            from: `"${smtpConfig.from_name || 'Green Hack'}" <${smtpConfig.from_email}>`,
            ...options
        });
        return {
            success: true,
            message: `Email sent successfully to ${options.to}`
        };
    } catch (error) {
        console.error("Email Service: Error sending email:", error);
        return {
            success: false,
            message: `Failed to send email: ${error.message}`,
            error
        };
    }
}
async function sendRegistrationWelcomeEmail(to, username) {
    const notificationSettings = await getNotificationSettings();
    if (!notificationSettings?.notify_on_registration) {
        console.log("Email Service: Registration notifications are disabled.");
        return;
    }
    await sendEmail({
        to,
        subject: `Добро пожаловать на Green Hacks, ${username}!`,
        text: `Привет, ${username}!\n\nСпасибо за регистрацию на Green Hacks. Ваш аккаунт успешно создан.\n\nС уважением,\nКоманда Green Hacks`,
        html: `<p>Привет, ${username}!</p><p>Спасибо за регистрацию на <strong>Green Hacks</strong>. Ваш аккаунт успешно создан.</p><p>С уважением,<br/>Команда Green Hacks</p>`
    });
}
async function sendPurchaseConfirmationEmail(to, username, productName, durationDays, amountPaidGh) {
    const notificationSettings = await getNotificationSettings();
    if (!notificationSettings?.notify_on_product_purchase) {
        console.log("Email Service: Product purchase notifications are disabled.");
        return;
    }
    const durationText = durationDays ? ` (на ${durationDays} дн.)` : '';
    await sendEmail({
        to,
        subject: 'Подтверждение покупки на Green Hacks',
        text: `Привет, ${username}!\n\nВы успешно приобрели "${productName}${durationText}" за ${amountPaidGh.toFixed(2)} GH.\n\nТовар добавлен в ваш инвентарь.\n\nС уважением,\nКоманда Green Hacks`,
        html: `<p>Привет, ${username}!</p><p>Вы успешно приобрели "<strong>${productName}${durationText}</strong>" за <strong>${amountPaidGh.toFixed(2)} GH</strong>.</p><p>Товар добавлен в ваш инвентарь.</p><p>С уважением,<br/>Команда Green Hacks</p>`
    });
}
async function sendBalanceUpdateEmail(to, username, amountGh, reason, newBalance) {
    const notificationSettings = await getNotificationSettings();
    if (!notificationSettings?.notify_on_balance_deposit) {
        console.log("Email Service: Balance update notifications are disabled.");
        return;
    }
    const actionText = amountGh > 0 ? "пополнен" : "изменен";
    const amountText = amountGh > 0 ? `+${amountGh.toFixed(2)} GH` : `${amountGh.toFixed(2)} GH`;
    await sendEmail({
        to,
        subject: `Обновление баланса на Green Hacks`,
        text: `Привет, ${username}!\n\nВаш баланс был ${actionText} на ${amountText}. Причина: ${reason}.\nНовый баланс: ${newBalance.toFixed(2)} GH.\n\nС уважением,\nКоманда Green Hacks`,
        html: `<p>Привет, ${username}!</p><p>Ваш баланс был ${actionText} на <strong>${amountText}</strong>. Причина: ${reason}.</p><p>Новый баланс: <strong>${newBalance.toFixed(2)} GH</strong>.</p><p>С уважением,<br/>Команда Green Hacks</p>`
    });
}
}}),
"[project]/src/app/api/auth/register/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
// src/app/api/auth/register/route.ts
__turbopack_context__.s({
    "POST": (()=>POST)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/mysql.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$bcryptjs$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/bcryptjs/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$email$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/email.ts [app-route] (ecmascript)");
;
;
;
;
const SETTINGS_ROW_ID = 1;
async function POST(request) {
    try {
        const { email, username, password, referralCode: providedReferralCode } = await request.json();
        if (!email || !username || !password) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Missing required fields (email, username, password)'
            }, {
                status: 400
            });
        }
        if (password.length < 6) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Password must be at least 6 characters long'
            }, {
                status: 400
            });
        }
        try {
            const existingUserByEmail = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT id FROM users WHERE email = ?', [
                email
            ]);
            if (Array.isArray(existingUserByEmail) && existingUserByEmail.length > 0) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    message: 'Пользователь с таким email уже существует.'
                }, {
                    status: 409
                });
            }
            const existingUserByUsername = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT id FROM users WHERE username = ?', [
                username
            ]);
            if (Array.isArray(existingUserByUsername) && existingUserByUsername.length > 0) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    message: 'Пользователь с таким логином уже существует.'
                }, {
                    status: 409
                });
            }
        } catch (checkError) {
            console.error('API Error checking existing user:', checkError);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: `Database error during user check: ${checkError.message}`
            }, {
                status: 500
            });
        }
        let referredByUserId = null;
        if (providedReferralCode) {
            const referrerResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT id FROM users WHERE referral_code = ?', [
                providedReferralCode
            ]);
            if (Array.isArray(referrerResult) && referrerResult.length > 0) {
                referredByUserId = referrerResult[0].id;
            }
        }
        const hashedPassword = await __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$bcryptjs$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].hash(password, 10);
        const newReferralCode = `GH-${username.toUpperCase().slice(0, 5)}${Date.now().toString().slice(-4)}`;
        const userBalance = 0.00;
        const defaultReferralPercentage = 5.00; // Default referral percentage for new users
        const result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('INSERT INTO users (email, username, password_hash, role, balance, referral_code, referred_by_user_id, referral_percentage) VALUES (?, ?, ?, ?, ?, ?, ?, ?)', [
            email,
            username,
            hashedPassword,
            'client',
            userBalance,
            newReferralCode,
            referredByUserId,
            defaultReferralPercentage
        ]);
        const insertResult = result;
        let insertId;
        if (Array.isArray(insertResult) && insertResult.length > 0 && 'insertId' in insertResult[0]) {
            insertId = insertResult[0].insertId;
        } else if (insertResult && 'insertId' in insertResult) {
            insertId = insertResult.insertId;
        }
        if (insertId) {
            const newUser = {
                id: insertId,
                email,
                username,
                role: 'client',
                balance: userBalance,
                referral_code: newReferralCode,
                referred_by_user_id: referredByUserId,
                referral_percentage: defaultReferralPercentage
            };
            if (referredByUserId) {
                await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('INSERT INTO referrals (referrer_user_id, referred_user_id, status) VALUES (?, ?, ?)', [
                    referredByUserId,
                    insertId,
                    'pending_purchase'
                ]);
            }
            try {
                const notificationSettingsResults = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT notify_on_registration FROM site_notification_settings WHERE id = ? LIMIT 1', [
                    SETTINGS_ROW_ID
                ]);
                if (notificationSettingsResults.length > 0 && Boolean(notificationSettingsResults[0].notify_on_registration)) {
                    await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$email$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["sendRegistrationWelcomeEmail"])(email, username);
                }
            } catch (emailError) {
                console.error("Failed to send registration email:", emailError);
            }
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'User registered successfully',
                user: newUser
            }, {
                status: 201
            });
        } else {
            console.error('User registration in DB failed, no insertId:', result);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Failed to register user in DB.'
            }, {
                status: 500
            });
        }
    } catch (error) {
        console.error('API Error processing registration request:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            message: `Internal Server Error: ${error.message}`
        }, {
            status: 500
        });
    }
}
}}),

};

//# sourceMappingURL=%5Broot%20of%20the%20server%5D__c39920cf._.js.map