module.exports = {

"[project]/.next-internal/server/app/api/purchase/product/route/actions.js [app-rsc] (server actions loader, ecmascript)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route.runtime.dev.js [external] (next/dist/compiled/next-server/app-route.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/@opentelemetry/api [external] (@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@opentelemetry/api", () => require("@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page.runtime.dev.js [external] (next/dist/compiled/next-server/app-page.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/process [external] (process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[externals]/timers [external] (timers, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("timers", () => require("timers"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/string_decoder [external] (string_decoder, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("string_decoder", () => require("string_decoder"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[project]/src/lib/mysql.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
/* __next_internal_action_entry_do_not_use__ {"6058d2186d06199210990ee590d0261587c858a217":"query"} */ __turbopack_context__.s({
    "query": (()=>query)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$app$2d$render$2f$encryption$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/app-render/encryption.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/mysql2/promise.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-route] (ecmascript)");
;
;
;
const connectionConfig = {
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
    connectionLimit: 10,
    namedPlaceholders: true
};
let pool = null;
function getPool() {
    if (!pool) {
        if (!process.env.DB_HOST || !process.env.DB_USER || !process.env.DB_NAME) {
            console.error("Database environment variables DB_HOST, DB_USER, or DB_NAME are not set.");
            throw new Error("Database environment variables are not fully set. Please check your .env.local file.");
        }
        try {
            pool = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createPool(connectionConfig);
            console.log("MySQL connection pool created successfully.");
            // Test the pool by getting a connection (optional, but good for early feedback)
            pool.getConnection().then((connection)=>{
                console.log("Successfully connected to database via pool.");
                connection.release();
            }).catch((err)=>{
                console.error("Failed to get a connection from pool on startup:", err);
            // Depending on severity, you might want to invalidate the pool or exit
            // For now, we'll let further queries fail if the pool is truly unusable.
            });
        } catch (error) {
            console.error("Failed to create MySQL connection pool:", error);
            // Ensure pool remains null if creation fails
            pool = null;
            throw new Error("Database connection pool could not be created.");
        }
    }
    return pool;
}
async function /*#__TURBOPACK_DISABLE_EXPORT_MERGING__*/ query(sql, params) {
    const currentPool = getPool(); // This will throw if pool cannot be initialized
    let connection;
    try {
        connection = await currentPool.getConnection();
        console.log(`Executing SQL: ${sql} with params: ${params ? JSON.stringify(params) : 'No params'}`);
        const [results] = await connection.execute(sql, params);
        return results;
    } catch (error) {
        console.error('Database query error:', error.message, error.code, error.sqlMessage, error.sql);
        throw new Error(`Database query failed: ${error.message}`);
    } finally{
        if (connection) {
            connection.release();
        }
    }
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    query
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(query, "6058d2186d06199210990ee590d0261587c858a217", null);
}}),
"[externals]/fs [external] (fs, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/dns [external] (dns, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("dns", () => require("dns"));

module.exports = mod;
}}),
"[externals]/os [external] (os, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}}),
"[externals]/path [external] (path, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}}),
"[externals]/child_process [external] (child_process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}}),
"[externals]/fs/promises [external] (fs/promises, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs/promises", () => require("fs/promises"));

module.exports = mod;
}}),
"[project]/src/lib/email.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
// src/lib/email.ts
__turbopack_context__.s({
    "sendBalanceUpdateEmail": (()=>sendBalanceUpdateEmail),
    "sendEmail": (()=>sendEmail),
    "sendPurchaseConfirmationEmail": (()=>sendPurchaseConfirmationEmail),
    "sendRegistrationWelcomeEmail": (()=>sendRegistrationWelcomeEmail)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$nodemailer$2f$lib$2f$nodemailer$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/nodemailer/lib/nodemailer.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/mysql.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$fs$2f$promises__$5b$external$5d$__$28$fs$2f$promises$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/fs/promises [external] (fs/promises, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/path [external] (path, cjs)");
;
;
;
;
const SETTINGS_ROW_ID = 1;
async function getSmtpSettings() {
    try {
        const results = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT * FROM site_smtp_settings WHERE id = ? LIMIT 1', [
            SETTINGS_ROW_ID
        ]);
        if (results.length > 0) {
            return results[0];
        }
        return null;
    } catch (error) {
        console.error("Error fetching SMTP settings for email:", error);
        return null;
    }
}
async function getNotificationSettings() {
    try {
        const results = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT * FROM site_notification_settings WHERE id = ? LIMIT 1', [
            SETTINGS_ROW_ID
        ]);
        if (results.length > 0) {
            const settings = results[0];
            return {
                id: settings.id,
                notify_on_registration: Boolean(settings.notify_on_registration),
                notify_on_balance_deposit: Boolean(settings.notify_on_balance_deposit),
                notify_on_product_purchase: Boolean(settings.notify_on_product_purchase),
                notify_on_support_reply: Boolean(settings.notify_on_support_reply),
                notify_on_software_activation: Boolean(settings.notify_on_software_activation),
                notify_on_license_expiry_soon: Boolean(settings.notify_on_license_expiry_soon),
                notify_on_promotions: Boolean(settings.notify_on_promotions),
                updated_at: settings.updated_at
            };
        }
        return null;
    } catch (error) {
        console.error("Error fetching notification settings for email:", error);
        return null;
    }
}
async function renderEmailTemplate(templateName, data) {
    try {
        const baseTemplatePath = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].join(process.cwd(), 'src', 'emails', 'base-email-template.html');
        const specificTemplatePath = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].join(process.cwd(), 'src', 'emails', `${templateName}.html`);
        let baseTemplateContent = await __TURBOPACK__imported__module__$5b$externals$5d2f$fs$2f$promises__$5b$external$5d$__$28$fs$2f$promises$2c$__cjs$29$__["default"].readFile(baseTemplatePath, 'utf-8');
        let specificTemplateContent = await __TURBOPACK__imported__module__$5b$externals$5d2f$fs$2f$promises__$5b$external$5d$__$28$fs$2f$promises$2c$__cjs$29$__["default"].readFile(specificTemplatePath, 'utf-8');
        // Populate specific template
        for(const key in data){
            specificTemplateContent = specificTemplateContent.replace(new RegExp(`{{${key}}}`, 'g'), String(data[key] === null || data[key] === undefined ? '' : data[key]));
        }
        // Populate base template
        baseTemplateContent = baseTemplateContent.replace(new RegExp(`{{emailBody}}`, 'g'), specificTemplateContent);
        baseTemplateContent = baseTemplateContent.replace(new RegExp(`{{emailTitle}}`, 'g'), String(data.emailTitle || data.subject || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç ' + (data.siteName || '—Å–∞–π—Ç–∞')));
        baseTemplateContent = baseTemplateContent.replace(new RegExp(`{{siteName}}`, 'g'), String(data.siteName || 'Green Hacks'));
        baseTemplateContent = baseTemplateContent.replace(new RegExp(`{{currentYear}}`, 'g'), String(new Date().getFullYear()));
        baseTemplateContent = baseTemplateContent.replace(new RegExp(`{{siteUrl}}`, 'g'), String(data.siteUrl || ("TURBOPACK compile-time value", "https://greenhacks.ru") || '#'));
        return baseTemplateContent;
    } catch (error) {
        console.error(`Error rendering email template ${templateName}:`, error);
        throw new Error(`Failed to render email template ${templateName}.`);
    }
}
async function sendEmail(options) {
    const smtpConfig = await getSmtpSettings();
    if (!smtpConfig || !smtpConfig.smtp_host || !smtpConfig.smtp_port || !smtpConfig.from_email) {
        console.error("Email Service: SMTP settings are incomplete or not found.");
        return {
            success: false,
            message: "SMTP settings are incomplete."
        };
    }
    const transporterOptions = {
        host: smtpConfig.smtp_host,
        port: Number(smtpConfig.smtp_port),
        secure: Number(smtpConfig.smtp_port) === 465 || smtpConfig.smtp_encryption === 'ssl',
        auth: smtpConfig.smtp_username && smtpConfig.smtp_password ? {
            user: smtpConfig.smtp_username,
            pass: smtpConfig.smtp_password
        } : undefined
    };
    if (smtpConfig.smtp_encryption === 'tls' && Number(smtpConfig.smtp_port) !== 465) {
        transporterOptions.secure = false;
        transporterOptions.requireTLS = true;
    } else if (smtpConfig.smtp_encryption === 'none' && Number(smtpConfig.smtp_port) !== 465) {
        transporterOptions.secure = false;
        transporterOptions.ignoreTLS = true;
    }
    const transporter = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$nodemailer$2f$lib$2f$nodemailer$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createTransport(transporterOptions);
    try {
        await transporter.verify();
        console.log(`Email Service: Sending email to ${options.to} with subject "${options.subject}"`);
        await transporter.sendMail({
            from: `"${smtpConfig.from_name || 'Green Hack'}" <${smtpConfig.from_email}>`,
            ...options
        });
        return {
            success: true,
            message: `Email sent successfully to ${options.to}`
        };
    } catch (error) {
        console.error("Email Service: Error sending email:", error);
        return {
            success: false,
            message: `Failed to send email: ${error.message}`,
            error
        };
    }
}
async function sendRegistrationWelcomeEmail(to, username) {
    const notificationSettings = await getNotificationSettings();
    if (!notificationSettings?.notify_on_registration) {
        console.log("Email Service: Registration notifications are disabled.");
        return;
    }
    const smtpConfig = await getSmtpSettings();
    const siteName = smtpConfig?.from_name || process.env.NEXT_PUBLIC_SITE_NAME || 'Green Hacks';
    const siteUrl = ("TURBOPACK compile-time value", "https://greenhacks.ru") || '#';
    const subject = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ ${siteName}, ${username}!`;
    try {
        const htmlBody = await renderEmailTemplate('registration', {
            username: username,
            siteName: siteName,
            loginLink: `${siteUrl}/auth/login`,
            emailTitle: subject,
            subject: subject,
            siteUrl: siteUrl
        });
        await sendEmail({
            to,
            subject: subject,
            text: `–ü—Ä–∏–≤–µ—Ç, ${username}!\n\n–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ ${siteName}. –í–∞—à –∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.\n\n–í–∞—à –ª–æ–≥–∏–Ω: ${username}\n\n–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç: ${siteUrl}\n–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç: ${siteUrl}/auth/login\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n–ö–æ–º–∞–Ω–¥–∞ ${siteName}`,
            html: htmlBody
        });
    } catch (error) {
        console.error("Error preparing or sending registration welcome email:", error);
    }
}
async function sendPurchaseConfirmationEmail(to, username, productName, durationDays, amountPaidGh) {
    const notificationSettings = await getNotificationSettings();
    if (!notificationSettings?.notify_on_product_purchase) {
        console.log("Email Service: Product purchase notifications are disabled.");
        return;
    }
    const smtpConfig = await getSmtpSettings();
    const siteName = smtpConfig?.from_name || process.env.NEXT_PUBLIC_SITE_NAME || 'Green Hacks';
    const siteUrl = ("TURBOPACK compile-time value", "https://greenhacks.ru") || '#';
    const subject = `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ ${siteName}`;
    const durationText = durationDays ? `${durationDays} –¥–Ω.` : '';
    try {
        const htmlBody = await renderEmailTemplate('purchase-confirmation', {
            username: username,
            siteName: siteName,
            productName: productName,
            productDuration: durationText,
            // productMode: '', // Placeholder, add if needed
            amountPaidGh: amountPaidGh.toFixed(2),
            purchaseDate: new Date().toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }),
            inventoryLink: `${siteUrl}/account/inventory`,
            emailTitle: subject,
            subject: subject,
            siteUrl: siteUrl
        });
        await sendEmail({
            to,
            subject: subject,
            text: `–ü—Ä–∏–≤–µ—Ç, ${username}!\n\n–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ–ª–∏ "${productName}"${durationText ? ` (${durationText})` : ''} –∑–∞ ${amountPaidGh.toFixed(2)} GH.\n\n–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å: ${siteUrl}/account/inventory\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n–ö–æ–º–∞–Ω–¥–∞ ${siteName}`,
            html: htmlBody
        });
    } catch (error) {
        console.error("Error preparing or sending purchase confirmation email:", error);
    }
}
async function sendBalanceUpdateEmail(to, username, amountGh, reason, newBalance) {
    const notificationSettings = await getNotificationSettings();
    if (!notificationSettings?.notify_on_balance_deposit) {
        console.log("Email Service: Balance update notifications are disabled.");
        return;
    }
    const smtpConfig = await getSmtpSettings();
    const siteName = smtpConfig?.from_name || process.env.NEXT_PUBLIC_SITE_NAME || 'Green Hacks';
    const siteUrl = ("TURBOPACK compile-time value", "https://greenhacks.ru") || '#';
    const subject = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ ${siteName}`;
    const actionText = amountGh > 0 ? "–ø–æ–ø–æ–ª–Ω–µ–Ω" : "–∏–∑–º–µ–Ω–µ–Ω";
    const amountText = amountGh > 0 ? `+${amountGh.toFixed(2)} GH` : `${amountGh.toFixed(2)} GH`;
    try {
        const htmlBody = await renderEmailTemplate('balance-topup', {
            username: username,
            siteName: siteName,
            topUpAmountGh: amountText,
            paymentMethod: reason,
            topUpDate: new Date().toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }),
            newBalanceGh: newBalance.toFixed(2),
            accountBalanceLink: `${siteUrl}/account/balance`,
            emailTitle: subject,
            subject: subject,
            siteUrl: siteUrl
        });
        await sendEmail({
            to,
            subject: subject,
            text: `–ü—Ä–∏–≤–µ—Ç, ${username}!\n\n–í–∞—à –±–∞–ª–∞–Ω—Å –±—ã–ª ${actionText} –Ω–∞ ${amountText}. –ü—Ä–∏—á–∏–Ω–∞: ${reason}.\n–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${newBalance.toFixed(2)} GH.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n–ö–æ–º–∞–Ω–¥–∞ ${siteName}`,
            html: htmlBody
        });
    } catch (error) {
        console.error("Error preparing or sending balance update email:", error);
    }
}
}}),
"[project]/src/lib/telegram.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
// src/lib/telegram.ts
__turbopack_context__.s({
    "getTelegramSettingsFromDb": (()=>getTelegramSettingsFromDb),
    "notifyAdminOnAdminLogin": (()=>notifyAdminOnAdminLogin),
    "notifyAdminOnBalanceDeposit": (()=>notifyAdminOnBalanceDeposit),
    "notifyAdminOnProductPurchase": (()=>notifyAdminOnProductPurchase),
    "notifyAdminOnPromoCodeCreation": (()=>notifyAdminOnPromoCodeCreation),
    "sendKeyActivationRequestToAdmin": (()=>sendKeyActivationRequestToAdmin),
    "sendTelegramMessage": (()=>sendTelegramMessage)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/mysql.ts [app-route] (ecmascript)");
;
const SETTINGS_ROW_ID = 1; // Assuming settings are in a single row with id=1
async function getTelegramSettingsFromDb() {
    // console.log("[TelegramLib][getTelegramSettingsFromDb] Fetching Telegram configuration from DB...");
    try {
        const [tgSettingsResults, adminPrefsResults, siteNotificationSettingsResults] = await Promise.all([
            (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT * FROM site_telegram_settings WHERE id = ? LIMIT 1', [
                SETTINGS_ROW_ID
            ]),
            (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT * FROM admin_telegram_notification_prefs WHERE id = ? LIMIT 1', [
                SETTINGS_ROW_ID
            ]),
            (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT * FROM site_notification_settings WHERE id = ? LIMIT 1', [
                SETTINGS_ROW_ID
            ])
        ]);
        const telegramSettings = Array.isArray(tgSettingsResults) && tgSettingsResults.length > 0 ? tgSettingsResults[0] : null;
        const adminPrefsDb = Array.isArray(adminPrefsResults) && adminPrefsResults.length > 0 ? adminPrefsResults[0] : null;
        const notificationPrefs = adminPrefsDb ? {
            id: adminPrefsDb.id,
            notify_admin_on_balance_deposit: Boolean(adminPrefsDb.notify_admin_on_balance_deposit),
            notify_admin_on_product_purchase: Boolean(adminPrefsDb.notify_admin_on_product_purchase),
            notify_admin_on_promo_code_creation: Boolean(adminPrefsDb.notify_admin_on_promo_code_creation),
            notify_admin_on_admin_login: Boolean(adminPrefsDb.notify_admin_on_admin_login),
            notify_admin_on_key_activation_request: adminPrefsDb.notify_admin_on_key_activation_request === undefined ? true : Boolean(adminPrefsDb.notify_admin_on_key_activation_request),
            updated_at: adminPrefsDb.updated_at
        } : null;
        const siteNotificationSettingsDb = Array.isArray(siteNotificationSettingsResults) && siteNotificationSettingsResults.length > 0 ? siteNotificationSettingsResults[0] : null;
        const siteNotificationSettings = siteNotificationSettingsDb ? {
            id: siteNotificationSettingsDb.id || SETTINGS_ROW_ID,
            notify_on_registration: Boolean(siteNotificationSettingsDb.notify_on_registration),
            notify_on_balance_deposit: Boolean(siteNotificationSettingsDb.notify_on_balance_deposit),
            notify_on_product_purchase: Boolean(siteNotificationSettingsDb.notify_on_product_purchase),
            notify_on_support_reply: Boolean(siteNotificationSettingsDb.notify_on_support_reply),
            notify_on_software_activation: Boolean(siteNotificationSettingsDb.notify_on_software_activation),
            notify_on_license_expiry_soon: Boolean(siteNotificationSettingsDb.notify_on_license_expiry_soon),
            notify_on_promotions: Boolean(siteNotificationSettingsDb.notify_on_promotions),
            updated_at: siteNotificationSettingsDb.updated_at
        } : null;
        return {
            telegramSettings,
            notificationPrefs,
            siteNotificationSettings
        };
    } catch (error) {
        console.error("[TelegramLib][getTelegramSettingsFromDb] Error fetching Telegram configuration:", error);
        return {
            telegramSettings: null,
            notificationPrefs: null,
            siteNotificationSettings: null
        };
    }
}
async function sendTelegramMessage(botToken, chatId, message, parseMode = 'MarkdownV2', replyMarkup) {
    // console.log(`[TelegramLib] sendTelegramMessage called. Token (start): ${botToken ? botToken.substring(0,10) + '...' : 'N/A'}, ChatID: ${chatId}, Message (start): "${message.substring(0,30)}...", ParseMode: ${parseMode}`);
    if (!botToken || !chatId || !message) {
        const errorMsg = "[TelegramLib] Send Error: Missing botToken, chatId, or message for Telegram.";
        console.error(errorMsg);
        return {
            success: false,
            message: errorMsg
        };
    }
    const telegramApiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;
    const bodyPayload = {
        chat_id: chatId,
        text: message,
        parse_mode: parseMode
    };
    if (replyMarkup) {
        bodyPayload.reply_markup = replyMarkup;
    }
    // console.log(`[TelegramLib] Preparing to send. Final chat_id type: ${typeof bodyPayload.chat_id}, value: '${bodyPayload.chat_id}'`);
    // console.log(`[TelegramLib] EXACT PAYLOAD TO TELEGRAM (token details excluded):`, JSON.stringify({ ...bodyPayload, bot_token_info: `Token ending with ...${botToken.slice(-6)}` }, null, 2));
    try {
        const response = await fetch(telegramApiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(bodyPayload)
        });
        const data = await response.json();
        // console.log(`[TelegramLib] Telegram API response status: ${response.status}, ok: ${response.ok}`);
        // console.log('[TelegramLib] Telegram API response data:', JSON.stringify(data, null, 2));
        if (data.ok) {
            // console.log(`[TelegramLib] Message sent successfully to chat_id ${chatId}.`);
            return {
                success: true,
                message: `Message sent to ${chatId}`
            };
        } else {
            let detailedMessage = `Telegram API Error: ${data.description || 'Unknown error from Telegram API'}`;
            if (data.description && String(data.description).toLowerCase().includes("chat not found")) {
                detailedMessage = `Telegram API Error for Chat ID '${chatId}': ${data.description} (Hint: Ensure bot has access to this specific Chat ID. If it's a user ID, the user must have started the bot. If it's a group/channel ID, the bot must be a member/admin and the ID should typically be negative for groups/supergroups. Verify the bot is in the group/channel.)`;
            }
            return {
                success: false,
                message: detailedMessage,
                error: data
            };
        }
    } catch (error) {
        console.error('[TelegramLib] Error sending Telegram message via fetch:', error);
        return {
            success: false,
            message: `Network or parsing error: ${error.message}`,
            error
        };
    }
}
function escapeTelegramMarkdownV2(text) {
    if (text === null || text === undefined) return '';
    const textStr = String(text);
    const escapeChars = [
        '_',
        '*',
        '[',
        ']',
        '(',
        ')',
        '~',
        '`',
        '>',
        '#',
        '+',
        '-',
        '=',
        '|',
        '{',
        '}',
        '.',
        '!'
    ];
    return textStr.split('').map((char)=>escapeChars.includes(char) ? `\\${char}` : char).join('');
}
async function notifyAdminOnBalanceDeposit(userId, username, amountGh, reason) {
    console.log(`[TelegramLib LOG] Attempting notifyAdminOnBalanceDeposit for user: ${username} (ID: ${userId}), amount: ${amountGh}, reason: ${reason || 'N/A'}`);
    const { telegramSettings, notificationPrefs } = await getTelegramSettingsFromDb();
    if (!telegramSettings?.admin_bot_token) {
        console.log("[TelegramLib LOG] notifyAdminOnBalanceDeposit: Admin bot token NOT configured.");
        return;
    }
    if (!telegramSettings.admin_bot_chat_ids) {
        console.log("[TelegramLib LOG] notifyAdminOnBalanceDeposit: Admin bot chat IDs NOT configured.");
        return;
    }
    if (!notificationPrefs?.notify_admin_on_balance_deposit) {
        console.log("[TelegramLib LOG] notifyAdminOnBalanceDeposit: Notification type is DISABLED in settings.");
        return;
    }
    console.log("[TelegramLib LOG] notifyAdminOnBalanceDeposit: Settings OK. Proceeding to send.");
    const reasonText = reason ? `\n–ü—Ä–∏—á–∏–Ω–∞: \`${escapeTelegramMarkdownV2(reason)}\`` : '';
    const message = `üí∞ *–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞*
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: \`${escapeTelegramMarkdownV2(username)}\` (ID: \`${userId}\`)
–°—É–º–º–∞: \`+${escapeTelegramMarkdownV2(amountGh.toFixed(2))}\` GH${reasonText}`;
    const chatIds = telegramSettings.admin_bot_chat_ids.split(',').map((id)=>id.trim()).filter((id)=>id);
    for (const chatId of chatIds){
        try {
            console.log(`[TelegramLib LOG] Sending balance deposit notification to admin chat ID: ${chatId}`);
            const result = await sendTelegramMessage(telegramSettings.admin_bot_token, chatId, message);
            if (!result.success) {
                console.error(`[TelegramLib LOG] Failed to send balance deposit notification to ${chatId}:`, result.message, result.error);
            } else {
                console.log(`[TelegramLib LOG] Balance deposit notification sent successfully to ${chatId}.`);
            }
        } catch (e) {
            console.error(`[TelegramLib LOG] CRITICAL ERROR sending balance deposit notification to ${chatId}:`, e);
        }
    }
}
async function notifyAdminOnProductPurchase(userId, username, productName, durationDays, amountGh) {
    console.log(`[TelegramLib LOG] Attempting notifyAdminOnProductPurchase for user: ${username}, product: ${productName}, amount: ${amountGh}`);
    const { telegramSettings, notificationPrefs } = await getTelegramSettingsFromDb();
    if (!telegramSettings?.admin_bot_token || !telegramSettings.admin_bot_chat_ids || !notificationPrefs?.notify_admin_on_product_purchase) {
        console.log("[TelegramLib LOG] notifyAdminOnProductPurchase: Check failed - Bot token, chat IDs, or setting disabled.");
        return;
    }
    console.log("[TelegramLib LOG] notifyAdminOnProductPurchase: Settings OK. Proceeding to send.");
    const durationText = durationDays ? ` (${escapeTelegramMarkdownV2(durationDays)} –¥–Ω\\.)` : '';
    const message = `üõçÔ∏è *–ù–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞*
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: \`${escapeTelegramMarkdownV2(username)}\` (ID: \`${userId}\`)
–¢–æ–≤–∞—Ä: \`${escapeTelegramMarkdownV2(productName)}\`${durationText}
–°—É–º–º–∞: \`${escapeTelegramMarkdownV2(amountGh.toFixed(2))}\` GH`;
    const chatIds = telegramSettings.admin_bot_chat_ids.split(',').map((id)=>id.trim()).filter((id)=>id);
    for (const chatId of chatIds){
        try {
            console.log(`[TelegramLib LOG] Sending product purchase notification to admin chat ID: ${chatId}`);
            const result = await sendTelegramMessage(telegramSettings.admin_bot_token, chatId, message);
            if (!result.success) {
                console.error(`[TelegramLib LOG] Failed to send product purchase notification to ${chatId}:`, result.message, result.error);
            } else {
                console.log(`[TelegramLib LOG] Product purchase notification sent successfully to ${chatId}.`);
            }
        } catch (e) {
            console.error(`[TelegramLib LOG] CRITICAL ERROR sending product purchase notification to ${chatId}:`, e);
        }
    }
}
async function notifyAdminOnPromoCodeCreation(adminUsername, promoCode) {
    console.log(`[TelegramLib LOG] Attempting notifyAdminOnPromoCodeCreation for code: ${promoCode.code}, created by: ${adminUsername || 'System'}`);
    const { telegramSettings, notificationPrefs } = await getTelegramSettingsFromDb();
    if (!telegramSettings?.admin_bot_token || !telegramSettings.admin_bot_chat_ids || !notificationPrefs?.notify_admin_on_promo_code_creation) {
        console.log("[TelegramLib LOG] notifyAdminOnPromoCodeCreation: Check failed - Bot token, chat IDs, or setting disabled.");
        return;
    }
    console.log("[TelegramLib LOG] notifyAdminOnPromoCodeCreation: Settings OK. Proceeding to send.");
    let rewardText = '';
    if (promoCode.type === 'balance_gh' && promoCode.value_gh) {
        rewardText = `–ë–∞–ª–∞–Ω—Å: \`${escapeTelegramMarkdownV2(promoCode.value_gh.toFixed(2))}\` GH`;
    } else if (promoCode.type === 'product' && promoCode.product_name) {
        const duration = promoCode.duration_days ? ` (${escapeTelegramMarkdownV2(promoCode.duration_days)} –¥–Ω\\.)` : '';
        const mode = promoCode.mode_label ? ` [${escapeTelegramMarkdownV2(promoCode.mode_label)}]` : '';
        rewardText = `–¢–æ–≤–∞—Ä: \`${escapeTelegramMarkdownV2(promoCode.product_name)}\`${duration}${mode}`;
    }
    const message = `üéÅ *–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥*
–ö–æ–¥: \`${escapeTelegramMarkdownV2(promoCode.code)}\`
–¢–∏–ø: \`${escapeTelegramMarkdownV2(promoCode.type)}\`
–ù–∞–≥—Ä–∞–¥–∞: ${rewardText}
–ú–∞–∫—Å\\. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: \`${promoCode.max_uses}\`
–ò—Å—Ç–µ–∫–∞–µ—Ç: \`${promoCode.expires_at ? escapeTelegramMarkdownV2(new Date(promoCode.expires_at).toLocaleString('ru-RU')) : '–ë–µ—Å—Å—Ä–æ—á–Ω–æ'}\`
${adminUsername ? `–°–æ–∑–¥–∞–ª: \`${escapeTelegramMarkdownV2(adminUsername)}\`` : '–°–æ–∑–¥–∞–Ω —Å–∏—Å—Ç–µ–º–æ–π'}`;
    const chatIds = telegramSettings.admin_bot_chat_ids.split(',').map((id)=>id.trim()).filter((id)=>id);
    for (const chatId of chatIds){
        try {
            console.log(`[TelegramLib LOG] Sending promo code creation notification to admin chat ID: ${chatId}`);
            const result = await sendTelegramMessage(telegramSettings.admin_bot_token, chatId, message);
            if (!result.success) {
                console.error(`[TelegramLib LOG] Failed to send promo code creation notification to ${chatId}:`, result.message, result.error);
            } else {
                console.log(`[TelegramLib LOG] Promo code creation notification sent successfully to ${chatId}.`);
            }
        } catch (e) {
            console.error(`[TelegramLib LOG] CRITICAL ERROR sending promo code creation notification to ${chatId}:`, e);
        }
    }
}
async function notifyAdminOnAdminLogin(adminUsername, ipAddress) {
    console.log(`[TelegramLib LOG] Attempting notifyAdminOnAdminLogin for admin: ${adminUsername}, IP: ${ipAddress}`);
    const { telegramSettings, notificationPrefs } = await getTelegramSettingsFromDb();
    if (!telegramSettings?.admin_bot_token || !telegramSettings.admin_bot_chat_ids || !notificationPrefs?.notify_admin_on_admin_login) {
        console.log("[TelegramLib LOG] notifyAdminOnAdminLogin: Check failed - Bot token, chat IDs, or setting disabled.");
        return;
    }
    console.log("[TelegramLib LOG] notifyAdminOnAdminLogin: Settings OK. Proceeding to send.");
    const ipText = ipAddress ? `IP: \`${escapeTelegramMarkdownV2(ipAddress)}\`` : 'IP –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
    const message = `üõ°Ô∏è *–í—Ö–æ–¥ –≤ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å*
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: \`${escapeTelegramMarkdownV2(adminUsername)}\`
${ipText}
–í—Ä–µ–º—è: \`${escapeTelegramMarkdownV2(new Date().toLocaleString('ru-RU'))}\``;
    const chatIds = telegramSettings.admin_bot_chat_ids.split(',').map((id)=>id.trim()).filter((id)=>id);
    for (const chatId of chatIds){
        try {
            console.log(`[TelegramLib LOG] Sending admin login notification to admin chat ID: ${chatId}`);
            const result = await sendTelegramMessage(telegramSettings.admin_bot_token, chatId, message);
            if (!result.success) {
                console.error(`[TelegramLib LOG] Failed to send admin login notification to ${chatId}:`, result.message, result.error);
            } else {
                console.log(`[TelegramLib LOG] Admin login notification sent successfully to ${chatId}.`);
            }
        } catch (e) {
            console.error(`[TelegramLib LOG] CRITICAL ERROR sending admin login notification to ${chatId}:`, e);
        }
    }
}
async function sendKeyActivationRequestToAdmin(item, user) {
    console.log(`[TelegramLib LOG] Attempting sendKeyActivationRequestToAdmin for item ID: ${item.id}, user: ${user.username}`);
    const { telegramSettings, notificationPrefs } = await getTelegramSettingsFromDb();
    const keyBotToken = telegramSettings?.key_bot_token;
    const adminChatIdsString = telegramSettings?.key_bot_admin_chat_ids;
    if (!keyBotToken) {
        const errorMsg = "[TelegramLib LOG] Key Bot token not configured in site_telegram_settings.";
        console.error(errorMsg);
        return {
            success: false,
            message: errorMsg
        };
    }
    if (!adminChatIdsString) {
        const errorMsg = "[TelegramLib LOG] Key Bot admin chat IDs not configured in site_telegram_settings.";
        console.error(errorMsg);
        return {
            success: false,
            message: errorMsg
        };
    }
    if (!notificationPrefs?.notify_admin_on_key_activation_request) {
        const logMsg = "[TelegramLib LOG] sendKeyActivationRequestToAdmin: Check failed - Notification type 'notify_admin_on_key_activation_request' is disabled.";
        console.log(logMsg);
        return {
            success: true,
            message: "Key activation request notification type disabled."
        };
    }
    console.log("[TelegramLib LOG] sendKeyActivationRequestToAdmin: Settings OK. Proceeding to send.");
    const productName = item.product_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä';
    const duration = item.duration_days ? ` (${item.duration_days} –¥–Ω.)` : '';
    const mode = item.mode_label ? ` [${item.mode_label}]` : '';
    const userKey = item.activation_code || '–ö–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω';
    const message = `üîë *–ó–∞–ø—Ä–æ—Å –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é –∫–ª—é—á–∞*
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: \`${escapeTelegramMarkdownV2(user.username)}\` (ID: \`${user.id}\`)
–¢–æ–≤–∞—Ä: \`${escapeTelegramMarkdownV2(productName)}${escapeTelegramMarkdownV2(duration)}${escapeTelegramMarkdownV2(mode)}\`
–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å ID: \`${item.id}\`
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–ª—é—á: \`${escapeTelegramMarkdownV2(userKey)}\``;
    const inline_keyboard = [
        [
            {
                text: '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å',
                callback_data: `activate_key:${item.id}`
            },
            {
                text: '‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å',
                callback_data: `reject_key:${item.id}`
            }
        ]
    ];
    const chatIds = adminChatIdsString.split(',').map((id)=>id.trim()).filter((id)=>id);
    let allSentSuccessfully = true;
    let firstErrorResult = null;
    for (const chatId of chatIds){
        try {
            console.log(`[TelegramLib LOG] Sending key activation request to key bot admin chat ID: ${chatId}`);
            const result = await sendTelegramMessage(keyBotToken, chatId, message, 'MarkdownV2', {
                inline_keyboard
            });
            if (!result.success) {
                allSentSuccessfully = false;
                if (!firstErrorResult) {
                    firstErrorResult = result;
                }
                console.error(`[TelegramLib LOG] Failed to send key activation request to ${chatId}:`, result.message, result.error);
            } else {
                console.log(`[TelegramLib LOG] Key activation request sent successfully to ${chatId}.`);
            }
        } catch (e) {
            allSentSuccessfully = false;
            if (!firstErrorResult) {
                firstErrorResult = {
                    success: false,
                    message: `Network or parsing error for key activation: ${e.message}`,
                    error: e
                };
            }
            console.error(`[TelegramLib LOG] CRITICAL ERROR sending key activation request to ${chatId}:`, e);
        }
    }
    return allSentSuccessfully ? {
        success: true,
        message: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."
    } : firstErrorResult || {
        success: false,
        message: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
    };
}
;
}}),
"[project]/src/app/api/purchase/product/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
// src/app/api/purchase/product/route.ts
__turbopack_context__.s({
    "POST": (()=>POST)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/mysql.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$email$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/email.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$telegram$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/telegram.ts [app-route] (ecmascript)");
;
;
;
;
const SETTINGS_ROW_ID = 1;
async function POST(request) {
    try {
        const { userId, productId, productPricingOptionId } = await request.json();
        if (!userId || !productId || !productPricingOptionId) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Missing required fields'
            }, {
                status: 400
            });
        }
        const usersFound = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT * FROM users WHERE id = ?', [
            userId
        ]);
        if (usersFound.length === 0) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'User not found'
            }, {
                status: 404
            });
        }
        const user = usersFound[0];
        const currentBalance = typeof user.balance === 'string' ? parseFloat(user.balance) : user.balance;
        const referredByUserId = user.referred_by_user_id;
        const buyerUsername = user.username;
        const pricingOptionsResults = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT * FROM product_pricing_options WHERE id = ? AND product_id = ?', [
            productPricingOptionId,
            productId
        ]);
        if (pricingOptionsResults.length === 0) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Pricing option not found or does not match product'
            }, {
                status: 404
            });
        }
        const selectedOption = {
            ...pricingOptionsResults[0],
            price_rub: parseFloat(pricingOptionsResults[0].price_rub),
            price_gh: parseFloat(pricingOptionsResults[0].price_gh),
            mode_label: pricingOptionsResults[0].mode_label
        };
        if (currentBalance < selectedOption.price_gh) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è ${selectedOption.price_gh.toFixed(2)} GH.`,
                currentBalance: currentBalance.toFixed(2)
            }, {
                status: 402
            });
        }
        const productsFound = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT name, image_url FROM products WHERE id = ?', [
            productId
        ]);
        if (productsFound.length === 0) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Product details not found for inventory logging.'
            }, {
                status: 404
            });
        }
        const productDetails = productsFound[0];
        const productName = productDetails.name;
        const productImageUrl = productDetails.image_url || null;
        const newBalance = currentBalance - selectedOption.price_gh;
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('UPDATE users SET balance = ? WHERE id = ?', [
            newBalance.toFixed(2),
            userId
        ]);
        const balanceTransactionResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('INSERT INTO balance_transactions (user_id, transaction_type, amount_gh, description) VALUES (?, ?, ?, ?)', [
            userId,
            'purchase_product',
            -selectedOption.price_gh,
            `–ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞: ${productName} (${selectedOption.duration_days} –¥–Ω.${selectedOption.mode_label ? `, ${selectedOption.mode_label}` : ''})`
        ]);
        const balanceTransactionId = balanceTransactionResult.insertId;
        const purchaseResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('INSERT INTO purchases (user_id, product_id, product_pricing_option_id, amount_paid_gh, status, balance_transaction_id) VALUES (?, ?, ?, ?, ?, ?)', [
            userId,
            productId,
            selectedOption.id,
            selectedOption.price_gh,
            'completed',
            balanceTransactionId
        ]);
        const purchaseId = purchaseResult.insertId;
        let expiresAt = null;
        if (selectedOption.duration_days) {
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + selectedOption.duration_days);
            expiresAt = expiryDate.toISOString().slice(0, 19).replace('T', ' ');
        }
        const activationCode = `GH-PROD-${Date.now().toString().slice(-6)}`;
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('INSERT INTO user_inventory (user_id, related_product_id, product_pricing_option_id, product_name, product_image_url, activation_code, expires_at, acquired_at, is_used, purchase_id) VALUES (?, ?, ?, ?, ?, ?, ?, NOW(), FALSE, ?)', [
            userId,
            productId,
            productPricingOptionId,
            productName,
            productImageUrl,
            activationCode,
            expiresAt,
            purchaseId
        ]);
        let referralTransactionId = null;
        if (referredByUserId) {
            const referrerResults = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT referral_percentage FROM users WHERE id = ?', [
                referredByUserId
            ]);
            if (referrerResults.length > 0) {
                const referrerReferralPercentage = parseFloat(referrerResults[0].referral_percentage || '5.00');
                const rewardAmountGh = selectedOption.price_gh * (referrerReferralPercentage / 100);
                if (rewardAmountGh > 0) {
                    await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('UPDATE users SET balance = balance + ? WHERE id = ?', [
                        rewardAmountGh.toFixed(2),
                        referredByUserId
                    ]);
                    const referralBonusTransactionResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('INSERT INTO balance_transactions (user_id, transaction_type, amount_gh, description) VALUES (?, ?, ?, ?)', [
                        referredByUserId,
                        'referral_bonus',
                        rewardAmountGh.toFixed(2),
                        `–ë–æ–Ω—É—Å –∑–∞ –ø–æ–∫—É–ø–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª–∞: ${buyerUsername} (${productName})`
                    ]);
                    referralTransactionId = referralBonusTransactionResult.insertId;
                    await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('UPDATE referrals SET status = ?, reward_amount_gh = ?, reward_claimed_at = NOW(), reward_description = ?, related_balance_transaction_id = ? WHERE referred_user_id = ? AND referrer_user_id = ? AND status = ?', [
                        'completed',
                        rewardAmountGh.toFixed(2),
                        `–ü–æ–∫—É–ø–∫–∞: ${productName} (${selectedOption.duration_days} –¥–Ω.${selectedOption.mode_label ? `, ${selectedOption.mode_label}` : ''})`,
                        referralTransactionId,
                        userId,
                        referredByUserId,
                        'pending_purchase'
                    ]);
                }
            }
        }
        const updatedUserResponse = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT * FROM users WHERE id = ?', [
            userId
        ]);
        const updatedUser = updatedUserResponse[0];
        if (updatedUser) {
            updatedUser.balance = parseFloat(updatedUser.balance);
            updatedUser.referral_percentage = parseFloat(updatedUser.referral_percentage);
        }
        try {
            const notificationSettingsResults = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$mysql$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])('SELECT notify_on_product_purchase FROM site_notification_settings WHERE id = ? LIMIT 1', [
                SETTINGS_ROW_ID
            ]);
            if (notificationSettingsResults.length > 0 && Boolean(notificationSettingsResults[0].notify_on_product_purchase)) {
                await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$email$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["sendPurchaseConfirmationEmail"])(user.email, user.username, productName, selectedOption.duration_days, selectedOption.price_gh);
            }
        } catch (emailError) {
            console.error("Failed to send purchase confirmation email:", emailError);
        }
        try {
            await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$telegram$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["notifyAdminOnProductPurchase"])(user.id, user.username, productName, selectedOption.duration_days, selectedOption.price_gh);
        } catch (telegramError) {
            console.error("Failed to send Telegram admin notification for product purchase:", telegramError);
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            message: `–ü–æ–∫—É–ø–∫–∞ "${productName}" (${selectedOption.duration_days} –¥–Ω.${selectedOption.mode_label ? `, ${selectedOption.mode_label}` : ''}) —É—Å–ø–µ—à–Ω–∞!`,
            updatedUser
        }, {
            status: 200
        });
    } catch (error) {
        console.error('API Product Purchase Error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            message: `Internal Server Error: ${error.message}`
        }, {
            status: 500
        });
    }
}
}}),

};

//# sourceMappingURL=%5Broot%20of%20the%20server%5D__5979a733._.js.map