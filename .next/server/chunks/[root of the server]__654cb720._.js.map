{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 156, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/mysql.ts"],"sourcesContent":["\n'use server'; // Add this directive\n\nimport mysql from 'mysql2/promise';\n\nconst connectionConfig = {\n  host: process.env.DB_HOST,\n  user: process.env.DB_USER,\n  password: process.env.DB_PASSWORD,\n  database: process.env.DB_NAME,\n  connectionLimit: 10, // Optional: connection pool limit\n  namedPlaceholders: true, // Important for using object parameters\n  // Add SSL options if your Jino.ru MySQL requires it\n  // ssl: {\n  //   // ca: fs.readFileSync('/path/to/ca-cert.pem'), // if you have a CA cert\n  //   rejectUnauthorized: false // Be cautious with this in production, true is more secure\n  // }\n};\n\nlet pool: mysql.Pool | null = null;\n\nfunction getPool(): mysql.Pool {\n  if (!pool) {\n    if (!process.env.DB_HOST || !process.env.DB_USER || !process.env.DB_NAME) { // Password can be empty for some local setups\n      console.error(\"Database environment variables DB_HOST, DB_USER, or DB_NAME are not set.\");\n      throw new Error(\"Database environment variables are not fully set. Please check your .env.local file.\");\n    }\n    try {\n      pool = mysql.createPool(connectionConfig);\n      console.log(\"MySQL connection pool created successfully.\");\n\n      // Test the pool by getting a connection (optional, but good for early feedback)\n      pool.getConnection()\n        .then(connection => {\n          console.log(\"Successfully connected to database via pool.\");\n          connection.release();\n        })\n        .catch(err => {\n          console.error(\"Failed to get a connection from pool on startup:\", err);\n          // Depending on severity, you might want to invalidate the pool or exit\n          // For now, we'll let further queries fail if the pool is truly unusable.\n        });\n\n    } catch (error) {\n      console.error(\"Failed to create MySQL connection pool:\", error);\n      // Ensure pool remains null if creation fails\n      pool = null;\n      throw new Error(\"Database connection pool could not be created.\");\n    }\n  }\n  return pool;\n}\n\nexport async function query(sql: string, params?: any[] | object): Promise<any> {\n  const currentPool = getPool(); // This will throw if pool cannot be initialized\n\n  let connection;\n  try {\n    connection = await currentPool.getConnection();\n    console.log(`Executing SQL: ${sql} with params: ${params ? JSON.stringify(params) : 'No params'}`);\n    const [results] = await connection.execute(sql, params);\n    return results;\n  } catch (error: any) {\n    console.error('Database query error:', error.message, error.code, error.sqlMessage, error.sql);\n    throw new Error(`Database query failed: ${error.message}`);\n  } finally {\n    if (connection) {\n      connection.release();\n    }\n  }\n}\n"],"names":[],"mappings":";;;;;AAGA;;;;;AAEA,MAAM,mBAAmB;IACvB,MAAM,QAAQ,GAAG,CAAC,OAAO;IACzB,MAAM,QAAQ,GAAG,CAAC,OAAO;IACzB,UAAU,QAAQ,GAAG,CAAC,WAAW;IACjC,UAAU,QAAQ,GAAG,CAAC,OAAO;IAC7B,iBAAiB;IACjB,mBAAmB;AAMrB;AAEA,IAAI,OAA0B;AAE9B,SAAS;IACP,IAAI,CAAC,MAAM;QACT,IAAI,CAAC,QAAQ,GAAG,CAAC,OAAO,IAAI,CAAC,QAAQ,GAAG,CAAC,OAAO,IAAI,CAAC,QAAQ,GAAG,CAAC,OAAO,EAAE;YACxE,QAAQ,KAAK,CAAC;YACd,MAAM,IAAI,MAAM;QAClB;QACA,IAAI;YACF,OAAO,mIAAA,CAAA,UAAK,CAAC,UAAU,CAAC;YACxB,QAAQ,GAAG,CAAC;YAEZ,gFAAgF;YAChF,KAAK,aAAa,GACf,IAAI,CAAC,CAAA;gBACJ,QAAQ,GAAG,CAAC;gBACZ,WAAW,OAAO;YACpB,GACC,KAAK,CAAC,CAAA;gBACL,QAAQ,KAAK,CAAC,oDAAoD;YAClE,uEAAuE;YACvE,yEAAyE;YAC3E;QAEJ,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,2CAA2C;YACzD,6CAA6C;YAC7C,OAAO;YACP,MAAM,IAAI,MAAM;QAClB;IACF;IACA,OAAO;AACT;AAEO,eAAe,uCAAG,GAAH,MAAM,GAAW,EAAE,MAAuB;IAC9D,MAAM,cAAc,WAAW,gDAAgD;IAE/E,IAAI;IACJ,IAAI;QACF,aAAa,MAAM,YAAY,aAAa;QAC5C,QAAQ,GAAG,CAAC,CAAC,eAAe,EAAE,IAAI,cAAc,EAAE,SAAS,KAAK,SAAS,CAAC,UAAU,aAAa;QACjG,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAChD,OAAO;IACT,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yBAAyB,MAAM,OAAO,EAAE,MAAM,IAAI,EAAE,MAAM,UAAU,EAAE,MAAM,GAAG;QAC7F,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,MAAM,OAAO,EAAE;IAC3D,SAAU;QACR,IAAI,YAAY;YACd,WAAW,OAAO;QACpB;IACF;AACF;;;IAjBsB;;AAAA,iPAAA","debugId":null}},
    {"offset": {"line": 230, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/telegram.ts"],"sourcesContent":["\n// src/lib/telegram.ts\nimport { query } from '@/lib/mysql';\nimport type { SiteTelegramSettings, AdminTelegramNotificationPrefs, Product, ProductPricingOption, InventoryItemWithDetails, User, SiteNotificationSettings } from '@/types';\n\nconst SETTINGS_ROW_ID = 1; // Assuming settings are in a single row with id=1\n\nasync function getTelegramSettingsFromDb(): Promise<{\n  telegramSettings: SiteTelegramSettings | null;\n  notificationPrefs: AdminTelegramNotificationPrefs | null;\n  siteNotificationSettings: SiteNotificationSettings | null; \n}> {\n  // console.log(\"[TelegramLib][getTelegramSettingsFromDb] Fetching Telegram configuration from DB...\");\n  try {\n    const [tgSettingsResults, adminPrefsResults, siteNotificationSettingsResults] = await Promise.all([\n      query('SELECT * FROM site_telegram_settings WHERE id = ? LIMIT 1', [SETTINGS_ROW_ID]),\n      query('SELECT * FROM admin_telegram_notification_prefs WHERE id = ? LIMIT 1', [SETTINGS_ROW_ID]),\n      query('SELECT * FROM site_notification_settings WHERE id = ? LIMIT 1', [SETTINGS_ROW_ID])\n    ]);\n\n    const telegramSettings: SiteTelegramSettings | null =\n      (Array.isArray(tgSettingsResults) && tgSettingsResults.length > 0) ? tgSettingsResults[0] : null;\n    \n    const adminPrefsDb = (Array.isArray(adminPrefsResults) && adminPrefsResults.length > 0) ? adminPrefsResults[0] : null;\n    const notificationPrefs: AdminTelegramNotificationPrefs | null = adminPrefsDb ? {\n        id: adminPrefsDb.id,\n        notify_admin_on_balance_deposit: Boolean(adminPrefsDb.notify_admin_on_balance_deposit),\n        notify_admin_on_product_purchase: Boolean(adminPrefsDb.notify_admin_on_product_purchase),\n        notify_admin_on_promo_code_creation: Boolean(adminPrefsDb.notify_admin_on_promo_code_creation),\n        notify_admin_on_admin_login: Boolean(adminPrefsDb.notify_admin_on_admin_login),\n        notify_admin_on_key_activation_request: adminPrefsDb.notify_admin_on_key_activation_request === undefined ? true : Boolean(adminPrefsDb.notify_admin_on_key_activation_request),\n        updated_at: adminPrefsDb.updated_at,\n    } : null;\n    \n    const siteNotificationSettingsDb = (Array.isArray(siteNotificationSettingsResults) && siteNotificationSettingsResults.length > 0) ? siteNotificationSettingsResults[0] : null;\n    const siteNotificationSettings: SiteNotificationSettings | null = siteNotificationSettingsDb ? {\n        id: siteNotificationSettingsDb.id || SETTINGS_ROW_ID, \n        notify_on_registration: Boolean(siteNotificationSettingsDb.notify_on_registration), \n        notify_on_balance_deposit: Boolean(siteNotificationSettingsDb.notify_on_balance_deposit),\n        notify_on_product_purchase: Boolean(siteNotificationSettingsDb.notify_on_product_purchase),\n        notify_on_support_reply: Boolean(siteNotificationSettingsDb.notify_on_support_reply),\n        notify_on_software_activation: Boolean(siteNotificationSettingsDb.notify_on_software_activation),\n        notify_on_license_expiry_soon: Boolean(siteNotificationSettingsDb.notify_on_license_expiry_soon),\n        notify_on_promotions: Boolean(siteNotificationSettingsDb.notify_on_promotions),\n        updated_at: siteNotificationSettingsDb.updated_at,\n    } : null;\n    \n    return { telegramSettings, notificationPrefs, siteNotificationSettings };\n  } catch (error) {\n    console.error(\"[TelegramLib][getTelegramSettingsFromDb] Error fetching Telegram configuration:\", error);\n    return { telegramSettings: null, notificationPrefs: null, siteNotificationSettings: null };\n  }\n}\n\n\nexport async function sendTelegramMessage(\n  botToken: string,\n  chatId: string, \n  message: string,\n  parseMode: 'MarkdownV2' | 'HTML' = 'MarkdownV2',\n  replyMarkup?: object \n): Promise<{ success: boolean; message?: string; error?: any }> {\n  // console.log(`[TelegramLib] sendTelegramMessage called. Token (start): ${botToken ? botToken.substring(0,10) + '...' : 'N/A'}, ChatID: ${chatId}, Message (start): \"${message.substring(0,30)}...\", ParseMode: ${parseMode}`);\n\n  if (!botToken || !chatId || !message) {\n    const errorMsg = \"[TelegramLib] Send Error: Missing botToken, chatId, or message for Telegram.\";\n    console.error(errorMsg);\n    return { success: false, message: errorMsg };\n  }\n\n  const telegramApiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;\n  \n  const bodyPayload: any = {\n    chat_id: chatId, \n    text: message,\n    parse_mode: parseMode,\n  };\n  if (replyMarkup) {\n    bodyPayload.reply_markup = replyMarkup;\n  }\n\n  // console.log(`[TelegramLib] Preparing to send. Final chat_id type: ${typeof bodyPayload.chat_id}, value: '${bodyPayload.chat_id}'`);\n  // console.log(`[TelegramLib] EXACT PAYLOAD TO TELEGRAM (token details excluded):`, JSON.stringify({ ...bodyPayload, bot_token_info: `Token ending with ...${botToken.slice(-6)}` }, null, 2));\n\n\n  try {\n    const response = await fetch(telegramApiUrl, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(bodyPayload),\n    });\n    const data = await response.json();\n    // console.log(`[TelegramLib] Telegram API response status: ${response.status}, ok: ${response.ok}`);\n    // console.log('[TelegramLib] Telegram API response data:', JSON.stringify(data, null, 2));\n\n\n    if (data.ok) {\n      // console.log(`[TelegramLib] Message sent successfully to chat_id ${chatId}.`);\n      return { success: true, message: `Message sent to ${chatId}` };\n    } else {\n      let detailedMessage = `Telegram API Error: ${data.description || 'Unknown error from Telegram API'}`;\n      if (data.description && String(data.description).toLowerCase().includes(\"chat not found\")) {\n        detailedMessage = `Telegram API Error for Chat ID '${chatId}': ${data.description} (Hint: Ensure bot has access to this specific Chat ID. If it's a user ID, the user must have started the bot. If it's a group/channel ID, the bot must be a member/admin and the ID should typically be negative for groups/supergroups. Verify the bot is in the group/channel.)`;\n      }\n      return { success: false, message: detailedMessage, error: data };\n    }\n  } catch (error: any) {\n    console.error('[TelegramLib] Error sending Telegram message via fetch:', error);\n    return { success: false, message: `Network or parsing error: ${error.message}`, error };\n  }\n}\n\nfunction escapeTelegramMarkdownV2(text: string | number | null | undefined): string {\n  if (text === null || text === undefined) return '';\n  const textStr = String(text);\n  const escapeChars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!'];\n  return textStr.split('').map(char => escapeChars.includes(char) ? `\\\\${char}` : char).join('');\n}\n\nexport async function notifyAdminOnBalanceDeposit(userId: number, username: string, amountGh: number, reason?: string) {\n  console.log(`[TelegramLib LOG] Attempting notifyAdminOnBalanceDeposit for user: ${username} (ID: ${userId}), amount: ${amountGh}, reason: ${reason || 'N/A'}`);\n  const { telegramSettings, notificationPrefs } = await getTelegramSettingsFromDb();\n\n  if (!telegramSettings?.admin_bot_token) {\n    console.log(\"[TelegramLib LOG] notifyAdminOnBalanceDeposit: Admin bot token NOT configured.\");\n    return;\n  }\n  if (!telegramSettings.admin_bot_chat_ids) {\n    console.log(\"[TelegramLib LOG] notifyAdminOnBalanceDeposit: Admin bot chat IDs NOT configured.\");\n    return;\n  }\n  if (!notificationPrefs?.notify_admin_on_balance_deposit) {\n    console.log(\"[TelegramLib LOG] notifyAdminOnBalanceDeposit: Notification type is DISABLED in settings.\");\n    return;\n  }\n  console.log(\"[TelegramLib LOG] notifyAdminOnBalanceDeposit: Settings OK. Proceeding to send.\");\n\n  const reasonText = reason ? `\\nПричина: \\`${escapeTelegramMarkdownV2(reason)}\\`` : '';\n  const message = `💰 *Пополнение баланса*\nПользователь: \\`${escapeTelegramMarkdownV2(username)}\\` (ID: \\`${userId}\\`)\nСумма: \\`+${escapeTelegramMarkdownV2(amountGh.toFixed(2))}\\` GH${reasonText}`;\n  \n  const chatIds = telegramSettings.admin_bot_chat_ids.split(',').map(id => id.trim()).filter(id => id);\n  for (const chatId of chatIds) {\n    try {\n      console.log(`[TelegramLib LOG] Sending balance deposit notification to admin chat ID: ${chatId}`);\n      const result = await sendTelegramMessage(telegramSettings.admin_bot_token, chatId, message);\n      if (!result.success) {\n          console.error(`[TelegramLib LOG] Failed to send balance deposit notification to ${chatId}:`, result.message, result.error);\n      } else {\n          console.log(`[TelegramLib LOG] Balance deposit notification sent successfully to ${chatId}.`);\n      }\n    } catch (e) {\n        console.error(`[TelegramLib LOG] CRITICAL ERROR sending balance deposit notification to ${chatId}:`, e);\n    }\n  }\n}\n\nexport async function notifyAdminOnProductPurchase(userId: number, username: string, productName: string, durationDays: number | null, amountGh: number) {\n  console.log(`[TelegramLib LOG] Attempting notifyAdminOnProductPurchase for user: ${username}, product: ${productName}, amount: ${amountGh}`);\n  const { telegramSettings, notificationPrefs } = await getTelegramSettingsFromDb();\n  if (!telegramSettings?.admin_bot_token || !telegramSettings.admin_bot_chat_ids || !notificationPrefs?.notify_admin_on_product_purchase) {\n    console.log(\"[TelegramLib LOG] notifyAdminOnProductPurchase: Check failed - Bot token, chat IDs, or setting disabled.\");\n    return;\n  }\n  console.log(\"[TelegramLib LOG] notifyAdminOnProductPurchase: Settings OK. Proceeding to send.\");\n  const durationText = durationDays ? ` (${escapeTelegramMarkdownV2(durationDays)} дн\\\\.)` : '';\n  const message = `🛍️ *Новая покупка товара*\nПользователь: \\`${escapeTelegramMarkdownV2(username)}\\` (ID: \\`${userId}\\`)\nТовар: \\`${escapeTelegramMarkdownV2(productName)}\\`${durationText}\nСумма: \\`${escapeTelegramMarkdownV2(amountGh.toFixed(2))}\\` GH`;\n\n  const chatIds = telegramSettings.admin_bot_chat_ids.split(',').map(id => id.trim()).filter(id => id);\n  for (const chatId of chatIds) {\n     try {\n        console.log(`[TelegramLib LOG] Sending product purchase notification to admin chat ID: ${chatId}`);\n        const result = await sendTelegramMessage(telegramSettings.admin_bot_token, chatId, message);\n        if (!result.success) {\n            console.error(`[TelegramLib LOG] Failed to send product purchase notification to ${chatId}:`, result.message, result.error);\n        } else {\n            console.log(`[TelegramLib LOG] Product purchase notification sent successfully to ${chatId}.`);\n        }\n    } catch (e) {\n        console.error(`[TelegramLib LOG] CRITICAL ERROR sending product purchase notification to ${chatId}:`, e);\n    }\n  }\n}\n\nexport async function notifyAdminOnPromoCodeCreation(\n  adminUsername: string | null,\n  promoCode: { code: string; type: string; value_gh?: number | null; product_name?: string; duration_days?: number | null; mode_label?: string | null; max_uses: number; expires_at?: string | null }\n) {\n  console.log(`[TelegramLib LOG] Attempting notifyAdminOnPromoCodeCreation for code: ${promoCode.code}, created by: ${adminUsername || 'System'}`);\n  const { telegramSettings, notificationPrefs } = await getTelegramSettingsFromDb();\n  if (!telegramSettings?.admin_bot_token || !telegramSettings.admin_bot_chat_ids || !notificationPrefs?.notify_admin_on_promo_code_creation) {\n    console.log(\"[TelegramLib LOG] notifyAdminOnPromoCodeCreation: Check failed - Bot token, chat IDs, or setting disabled.\");\n    return;\n  }\n  console.log(\"[TelegramLib LOG] notifyAdminOnPromoCodeCreation: Settings OK. Proceeding to send.\");\n\n  let rewardText = '';\n  if (promoCode.type === 'balance_gh' && promoCode.value_gh) {\n    rewardText = `Баланс: \\`${escapeTelegramMarkdownV2(promoCode.value_gh.toFixed(2))}\\` GH`;\n  } else if (promoCode.type === 'product' && promoCode.product_name) {\n    const duration = promoCode.duration_days ? ` (${escapeTelegramMarkdownV2(promoCode.duration_days)} дн\\\\.)` : '';\n    const mode = promoCode.mode_label ? ` [${escapeTelegramMarkdownV2(promoCode.mode_label)}]` : '';\n    rewardText = `Товар: \\`${escapeTelegramMarkdownV2(promoCode.product_name)}\\`${duration}${mode}`;\n  }\n\n  const message = `🎁 *Создан новый промокод*\nКод: \\`${escapeTelegramMarkdownV2(promoCode.code)}\\`\nТип: \\`${escapeTelegramMarkdownV2(promoCode.type)}\\`\nНаграда: ${rewardText}\nМакс\\\\. использований: \\`${promoCode.max_uses}\\`\nИстекает: \\`${promoCode.expires_at ? escapeTelegramMarkdownV2(new Date(promoCode.expires_at).toLocaleString('ru-RU')) : 'Бессрочно'}\\`\n${adminUsername ? `Создал: \\`${escapeTelegramMarkdownV2(adminUsername)}\\`` : 'Создан системой'}`;\n\n  const chatIds = telegramSettings.admin_bot_chat_ids.split(',').map(id => id.trim()).filter(id => id);\n  for (const chatId of chatIds) {\n    try {\n        console.log(`[TelegramLib LOG] Sending promo code creation notification to admin chat ID: ${chatId}`);\n        const result = await sendTelegramMessage(telegramSettings.admin_bot_token, chatId, message);\n        if (!result.success) {\n            console.error(`[TelegramLib LOG] Failed to send promo code creation notification to ${chatId}:`, result.message, result.error);\n        } else {\n            console.log(`[TelegramLib LOG] Promo code creation notification sent successfully to ${chatId}.`);\n        }\n    } catch (e) {\n        console.error(`[TelegramLib LOG] CRITICAL ERROR sending promo code creation notification to ${chatId}:`, e);\n    }\n  }\n}\n\nexport async function notifyAdminOnAdminLogin(adminUsername: string, ipAddress?: string) {\n    console.log(`[TelegramLib LOG] Attempting notifyAdminOnAdminLogin for admin: ${adminUsername}, IP: ${ipAddress}`);\n    const { telegramSettings, notificationPrefs } = await getTelegramSettingsFromDb();\n    if (!telegramSettings?.admin_bot_token || !telegramSettings.admin_bot_chat_ids || !notificationPrefs?.notify_admin_on_admin_login) {\n        console.log(\"[TelegramLib LOG] notifyAdminOnAdminLogin: Check failed - Bot token, chat IDs, or setting disabled.\");\n        return;\n    }\n    console.log(\"[TelegramLib LOG] notifyAdminOnAdminLogin: Settings OK. Proceeding to send.\");\n    const ipText = ipAddress ? `IP: \\`${escapeTelegramMarkdownV2(ipAddress)}\\`` : 'IP не определен';\n    const message = `🛡️ *Вход в Админ-панель*\nПользователь: \\`${escapeTelegramMarkdownV2(adminUsername)}\\`\n${ipText}\nВремя: \\`${escapeTelegramMarkdownV2(new Date().toLocaleString('ru-RU'))}\\``;\n\n    const chatIds = telegramSettings.admin_bot_chat_ids.split(',').map(id => id.trim()).filter(id => id);\n    for (const chatId of chatIds) {\n        try {\n            console.log(`[TelegramLib LOG] Sending admin login notification to admin chat ID: ${chatId}`);\n            const result = await sendTelegramMessage(telegramSettings.admin_bot_token, chatId, message);\n            if (!result.success) {\n                console.error(`[TelegramLib LOG] Failed to send admin login notification to ${chatId}:`, result.message, result.error);\n            } else {\n                console.log(`[TelegramLib LOG] Admin login notification sent successfully to ${chatId}.`);\n            }\n        } catch (e) {\n            console.error(`[TelegramLib LOG] CRITICAL ERROR sending admin login notification to ${chatId}:`, e);\n        }\n    }\n}\n\nexport async function sendKeyActivationRequestToAdmin(\n  item: InventoryItemWithDetails,\n  user: Pick<User, 'id' | 'username'>\n): Promise<{ success: boolean; message?: string; error?: any }> {\n  console.log(`[TelegramLib LOG] Attempting sendKeyActivationRequestToAdmin for item ID: ${item.id}, user: ${user.username}`);\n  const { telegramSettings, notificationPrefs } = await getTelegramSettingsFromDb();\n\n  const keyBotToken = telegramSettings?.key_bot_token;\n  const adminChatIdsString = telegramSettings?.key_bot_admin_chat_ids;\n\n  if (!keyBotToken) {\n    const errorMsg = \"[TelegramLib LOG] Key Bot token not configured in site_telegram_settings.\";\n    console.error(errorMsg);\n    return { success: false, message: errorMsg };\n  }\n  if (!adminChatIdsString) {\n    const errorMsg = \"[TelegramLib LOG] Key Bot admin chat IDs not configured in site_telegram_settings.\";\n    console.error(errorMsg);\n    return { success: false, message: errorMsg };\n  }\n\n  if (!notificationPrefs?.notify_admin_on_key_activation_request) {\n    const logMsg = \"[TelegramLib LOG] sendKeyActivationRequestToAdmin: Check failed - Notification type 'notify_admin_on_key_activation_request' is disabled.\";\n    console.log(logMsg);\n    return { success: true, message: \"Key activation request notification type disabled.\"};\n  }\n  console.log(\"[TelegramLib LOG] sendKeyActivationRequestToAdmin: Settings OK. Proceeding to send.\");\n\n  const productName = item.product_name || 'Неизвестный товар';\n  const duration = item.duration_days ? ` (${item.duration_days} дн.)` : '';\n  const mode = item.mode_label ? ` [${item.mode_label}]` : '';\n  const userKey = item.activation_code || 'Ключ не указан';\n\n  const message = `🔑 *Запрос на активацию ключа*\nПользователь: \\`${escapeTelegramMarkdownV2(user.username)}\\` (ID: \\`${user.id}\\`)\nТовар: \\`${escapeTelegramMarkdownV2(productName)}${escapeTelegramMarkdownV2(duration)}${escapeTelegramMarkdownV2(mode)}\\`\nИнвентарь ID: \\`${item.id}\\`\nПредоставленный ключ: \\`${escapeTelegramMarkdownV2(userKey)}\\``;\n\n  const inline_keyboard = [[\n    { text: '✅ Активировать', callback_data: `activate_key:${item.id}` },\n    { text: '❌ Отклонить', callback_data: `reject_key:${item.id}` },\n  ]];\n\n  const chatIds = adminChatIdsString.split(',').map(id => id.trim()).filter(id => id);\n  let allSentSuccessfully = true;\n  let firstErrorResult: { success: boolean; message?: string; error?: any } | null = null;\n\n  for (const chatId of chatIds) {\n    try {\n      console.log(`[TelegramLib LOG] Sending key activation request to key bot admin chat ID: ${chatId}`);\n      const result = await sendTelegramMessage(keyBotToken, chatId, message, 'MarkdownV2', { inline_keyboard });\n\n      if (!result.success) {\n        allSentSuccessfully = false;\n        if (!firstErrorResult) {\n          firstErrorResult = result;\n        }\n        console.error(`[TelegramLib LOG] Failed to send key activation request to ${chatId}:`, result.message, result.error);\n      } else {\n         console.log(`[TelegramLib LOG] Key activation request sent successfully to ${chatId}.`);\n      }\n    } catch (e: any) {\n        allSentSuccessfully = false;\n        if (!firstErrorResult) {\n            firstErrorResult = { success: false, message: `Network or parsing error for key activation: ${e.message}`, error: e };\n        }\n        console.error(`[TelegramLib LOG] CRITICAL ERROR sending key activation request to ${chatId}:`, e);\n    }\n  }\n  return allSentSuccessfully ? { success: true, message: \"Уведомление администратору отправлено.\"} : (firstErrorResult || { success: false, message: \"Неизвестная ошибка при отправке уведомлений администратору.\"});\n}\n\nexport { getTelegramSettingsFromDb };\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 602, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/api/admin/key-activation-requests/%5BinventoryItemId%5D/approve/route.ts"],"sourcesContent":["\n// src/app/api/admin/key-activation-requests/[inventoryItemId]/approve/route.ts\nimport { NextRequest, NextResponse } from 'next/server';\nimport { query } from '@/lib/mysql';\nimport type { OkPacket } from 'mysql2';\nimport type { InventoryItemWithDetails, User, SiteTelegramSettings, SiteNotificationSettings } from '@/types';\nimport { sendTelegramMessage, getTelegramSettingsFromDb } from '@/lib/telegram';\n// import { sendEmail } from '@/lib/email'; // Placeholder for email notification\n\nexport async function PUT(\n  request: NextRequest,\n  { params }: { params: { inventoryItemId: string } }\n) {\n  // TODO: Add admin authentication check\n  const inventoryItemId = parseInt(params.inventoryItemId, 10);\n  if (isNaN(inventoryItemId)) {\n    return NextResponse.json({ message: 'Invalid inventory item ID' }, { status: 400 });\n  }\n\n  try {\n    const itemDetailsResults = await query(\n      `SELECT \n         ui.*, \n         p.name as product_name_from_product_table,\n         COALESCE(ppo.duration_days, cp.duration_days) as resolved_duration_days,\n         ppo.mode_label as pricing_option_mode_label,\n         u.id as user_db_id, u.username as user_db_username, u.email as user_email, u.telegram_id as user_telegram_id\n       FROM user_inventory ui\n       LEFT JOIN products p ON ui.related_product_id = p.id\n       LEFT JOIN product_pricing_options ppo ON ui.product_pricing_option_id = ppo.id\n       LEFT JOIN case_prizes cp ON ui.case_prize_id = cp.id\n       LEFT JOIN users u ON ui.user_id = u.id\n       WHERE ui.id = ?`,\n      [inventoryItemId]\n    );\n\n    if (itemDetailsResults.length === 0) {\n      return NextResponse.json({ message: 'Предмет инвентаря не найден.' }, { status: 404 });\n    }\n    const item: InventoryItemWithDetails & { user_db_id: number, user_db_username: string, user_email?: string, user_telegram_id?: string, product_name_from_product_table?: string, pricing_option_mode_label?: string | null } = itemDetailsResults[0];\n    item.product_name = item.product_name || item.product_name_from_product_table || 'Неизвестный продукт';\n    item.duration_days = item.resolved_duration_days ? parseInt(item.resolved_duration_days as any, 10) : null;\n    item.mode_label = item.pricing_option_mode_label || null;\n\n    const activatedAt = new Date();\n    let expiresAt: string | null = null;\n\n    if (item.duration_days && item.duration_days > 0) {\n      const expiryDate = new Date(activatedAt);\n      expiryDate.setDate(expiryDate.getDate() + item.duration_days);\n      expiresAt = expiryDate.toISOString().slice(0, 19).replace('T', ' ');\n    }\n    \n    console.log(`Approving item ${inventoryItemId}. Duration: ${item.duration_days}, Calculated Expires At: ${expiresAt}`);\n\n    const result = await query(\n      'UPDATE user_inventory SET activation_status = ?, is_used = TRUE, activated_at = ?, expires_at = ?, updated_at = NOW() WHERE id = ? AND activation_status = ?',\n      ['active', activatedAt.toISOString().slice(0, 19).replace('T', ' '), expiresAt, inventoryItemId, 'pending_admin_approval']\n    ) as OkPacket;\n\n    if (result.affectedRows > 0) {\n      const { telegramSettings, siteNotificationSettings } = await getTelegramSettingsFromDb();\n      const clientBotToken = telegramSettings?.client_bot_token;\n\n      const userMessage = `Уважаемый пользователь, ваш ключ для \"${item.product_name}\"${item.duration_days ? ` на ${item.duration_days} дн.` : ''}${item.mode_label ? ` [${item.mode_label}]` : ''} был успешно активирован! Если вы не знаете как запустить софт, воспользуйтесь кнопкой \"Как запускать?\" в личном кабинете или напишите в техническую поддержку. Приятной игры!`;\n      \n      if (item.user_telegram_id && clientBotToken) {\n        console.log(`[ApproveKeyActivation] Sending Telegram notification to user ${item.user_telegram_id}...`);\n        await sendTelegramMessage(clientBotToken, item.user_telegram_id, userMessage, 'HTML');\n      } else {\n        console.log(`[ApproveKeyActivation] User ${item.user_telegram_id} Telegram ID or Client Bot Token not available. Skipping Telegram notification.`);\n      }\n\n      await query(\n        'INSERT INTO user_notifications (user_id, message, link_url) VALUES (?, ?, ?)',\n        [item.user_db_id, userMessage, '/account/inventory']\n      );\n      console.log(`[ApproveKeyActivation] Added notification to user_notifications for user ${item.user_db_id}.`);\n      \n      // if (siteNotificationSettings?.notify_on_software_activation && item.user_email) {\n      //   await sendEmail({\n      //     to: item.user_email,\n      //     subject: `Ваш ключ для ${item.product_name} активирован!`,\n      //     text: userMessage,\n      //     html: `<p>${userMessage.replace(/\\n/g, \"<br>\")}</p>`\n      //   });\n      // }\n      \n      return NextResponse.json({ message: 'Запрос на активацию ключа успешно одобрен. Пользователь уведомлен.' });\n    } else {\n      const currentStatusResult = await query('SELECT activation_status FROM user_inventory WHERE id = ?', [inventoryItemId]);\n      let currentStatus = 'unknown';\n      if (currentStatusResult.length > 0) {\n        currentStatus = currentStatusResult[0].activation_status;\n      }\n      if (currentStatus === 'active') {\n        return NextResponse.json({ message: 'Запрос уже был одобрен ранее.' }, { status: 200 });\n      }\n      return NextResponse.json({ message: 'Запрос не найден в статусе ожидания или уже обработан.', current_status: currentStatus }, { status: 404 });\n    }\n  } catch (error: any) {\n    console.error(`API Admin Approve Key Activation (ID: ${inventoryItemId}) Error:`, error);\n    return NextResponse.json({ message: `Internal Server Error: ${error.message}` }, { status: 500 });\n  }\n}\n    \n    "],"names":[],"mappings":"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","debugId":null}}]
}