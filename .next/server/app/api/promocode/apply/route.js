"use strict";(()=>{var e={};e.id=6137,e.ids=[6137],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:e=>{e.exports=require("process")},21111:(e,t,r)=>{r.d(t,{BR:()=>u,Gf:()=>p,Q7:()=>c});var s=r(49526),o=r(75365);async function a(){try{let e=await (0,o.P)("SELECT * FROM site_smtp_settings WHERE id = ? LIMIT 1",[1]);if(e.length>0)return e[0];return null}catch(e){return console.error("Error fetching SMTP settings for email:",e),null}}async function n(){try{let e=await (0,o.P)("SELECT * FROM site_notification_settings WHERE id = ? LIMIT 1",[1]);if(e.length>0){let t=e[0];return{id:t.id,notify_on_registration:!!t.notify_on_registration,notify_on_balance_deposit:!!t.notify_on_balance_deposit,notify_on_product_purchase:!!t.notify_on_product_purchase,notify_on_support_reply:!!t.notify_on_support_reply,notify_on_software_activation:!!t.notify_on_software_activation,notify_on_license_expiry_soon:!!t.notify_on_license_expiry_soon,notify_on_promotions:!!t.notify_on_promotions,updated_at:t.updated_at}}return null}catch(e){return console.error("Error fetching notification settings for email:",e),null}}async function i(e){let t=await a();if(!t||!t.smtp_host||!t.smtp_port||!t.from_email)return console.error("Email Service: SMTP settings are incomplete or not found."),{success:!1,message:"SMTP settings are incomplete."};let r={host:t.smtp_host,port:Number(t.smtp_port),secure:465===Number(t.smtp_port)||"ssl"===t.smtp_encryption,auth:t.smtp_username&&t.smtp_password?{user:t.smtp_username,pass:t.smtp_password}:void 0};"tls"===t.smtp_encryption&&465!==Number(t.smtp_port)?(r.secure=!1,r.requireTLS=!0):"none"===t.smtp_encryption&&465!==Number(t.smtp_port)&&(r.secure=!1,r.ignoreTLS=!0);let o=s.createTransport(r);try{return await o.verify(),console.log(`Email Service: Sending email to ${e.to} with subject "${e.subject}"`),await o.sendMail({from:`"${t.from_name||"Green Hack"}" <${t.from_email}>`,...e}),{success:!0,message:`Email sent successfully to ${e.to}`}}catch(e){return console.error("Email Service: Error sending email:",e),{success:!1,message:`Failed to send email: ${e.message}`,error:e}}}async function p(e,t){let r=await n();if(!r?.notify_on_registration){console.log("Email Service: Registration notifications are disabled.");return}await i({to:e,subject:`Добро пожаловать на Green Hacks, ${t}!`,text:`Привет, ${t}!

Спасибо за регистрацию на Green Hacks. Ваш аккаунт успешно создан.

С уважением,
Команда Green Hacks`,html:`<p>Привет, ${t}!</p><p>Спасибо за регистрацию на <strong>Green Hacks</strong>. Ваш аккаунт успешно создан.</p><p>С уважением,<br/>Команда Green Hacks</p>`})}async function u(e,t,r,s,o){let a=await n();if(!a?.notify_on_product_purchase){console.log("Email Service: Product purchase notifications are disabled.");return}let p=s?` (на ${s} дн.)`:"";await i({to:e,subject:"Подтверждение покупки на Green Hacks",text:`Привет, ${t}!

Вы успешно приобрели "${r}${p}" за ${o.toFixed(2)} GH.

Товар добавлен в ваш инвентарь.

С уважением,
Команда Green Hacks`,html:`<p>Привет, ${t}!</p><p>Вы успешно приобрели "<strong>${r}${p}</strong>" за <strong>${o.toFixed(2)} GH</strong>.</p><p>Товар добавлен в ваш инвентарь.</p><p>С уважением,<br/>Команда Green Hacks</p>`})}async function c(e,t,r,s,o){let a=await n();if(!a?.notify_on_balance_deposit){console.log("Email Service: Balance update notifications are disabled.");return}let p=r>0?"пополнен":"изменен",u=r>0?`+${r.toFixed(2)} GH`:`${r.toFixed(2)} GH`;await i({to:e,subject:`Обновление баланса на Green Hacks`,text:`Привет, ${t}!

Ваш баланс был ${p} на ${u}. Причина: ${s}.
Новый баланс: ${o.toFixed(2)} GH.

С уважением,
Команда Green Hacks`,html:`<p>Привет, ${t}!</p><p>Ваш баланс был ${p} на <strong>${u}</strong>. Причина: ${s}.</p><p>Новый баланс: <strong>${o.toFixed(2)} GH</strong>.</p><p>С уважением,<br/>Команда Green Hacks</p>`})}},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},37366:e=>{e.exports=require("dns")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57386:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>_,serverHooks:()=>g,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{POST:()=>l});var o=r(96559),a=r(48088),n=r(37719),i=r(32190),p=r(75365),u=r(21111),c=r(42192);async function l(e){try{let{userId:t,code:r}=await e.json();if(!t||!r)return i.NextResponse.json({message:"ID пользователя и код промокода обязательны."},{status:400});let s=await (0,p.P)("SELECT * FROM users WHERE id = ?",[t]);if(0===s.length)return i.NextResponse.json({message:"Пользователь не найден."},{status:404});let o=s[0];o.balance=parseFloat(o.balance);let a=await (0,p.P)("SELECT * FROM promo_codes WHERE code = ?",[r]);if(0===a.length)return i.NextResponse.json({message:"Промокод не найден или недействителен."},{status:404});let n={...a[0],is_active:!!a[0].is_active,value_gh:a[0].value_gh?parseFloat(a[0].value_gh):null};if(!n.is_active)return i.NextResponse.json({message:"Промокод больше не активен."},{status:400});if(n.expires_at&&new Date(n.expires_at)<new Date)return i.NextResponse.json({message:"Срок действия промокода истек."},{status:400});if(n.current_uses>=n.max_uses)return i.NextResponse.json({message:"Лимит использований этого промокода исчерпан (глобально)."},{status:400});let l=await (0,p.P)("SELECT id FROM user_promo_code_uses WHERE user_id = ? AND promo_code_id = ?",[t,n.id]);if(Array.isArray(l)&&l.length>0)return i.NextResponse.json({message:"Вы уже активировали данный промокод."},{status:400});let _="",d=o.balance;if("balance_gh"===n.type&&n.value_gh){d=o.balance+n.value_gh,await (0,p.P)("UPDATE users SET balance = ? WHERE id = ?",[d.toFixed(2),t]),await (0,p.P)("INSERT INTO balance_transactions (user_id, transaction_type, amount_gh, description) VALUES (?, ?, ?, ?)",[t,"deposit",n.value_gh,`Активация промокода: ${n.code} (+${n.value_gh} GH)`]),_=`Промокод "${n.code}" успешно применен! ${n.value_gh} GH зачислено на ваш баланс.`;try{let e=await (0,p.P)("SELECT notify_on_balance_deposit FROM site_notification_settings WHERE id = ? LIMIT 1",[1]);e.length>0&&e[0].notify_on_balance_deposit&&await (0,u.Q7)(o.email,o.username,n.value_gh,`Промокод: ${n.code}`,d)}catch(e){console.error("Failed to send balance update email after promo code:",e)}try{await (0,c._q)(o.id,o.username,n.value_gh)}catch(e){console.error("Failed to send Telegram admin notification for balance deposit (promo):",e)}}else{if("product"!==n.type||!n.related_product_id||!n.product_pricing_option_id)return i.NextResponse.json({message:"Неверный тип промокода или отсутствуют необходимые данные."},{status:500});let e=await (0,p.P)("SELECT name, image_url FROM products WHERE id = ?",[n.related_product_id]);if(0===e.length)return i.NextResponse.json({message:"Связанный с промокодом товар не найден."},{status:500});let r=e[0],s=await (0,p.P)("SELECT duration_days, mode_label FROM product_pricing_options WHERE id = ?",[n.product_pricing_option_id]);if(0===s.length)return i.NextResponse.json({message:"Связанный с промокодом вариант цены не найден."},{status:500});let o=s[0],a=null;if(o.duration_days){let e=new Date;e.setDate(e.getDate()+o.duration_days),a=e.toISOString().slice(0,19).replace("T"," ")}let u=`GH-PROMO-${Date.now().toString().slice(-5)}-${String(n.id||"0").slice(0,4)}`;await (0,p.P)("INSERT INTO user_inventory (user_id, related_product_id, product_pricing_option_id, product_name, product_image_url, activation_code, expires_at, acquired_at, is_used) VALUES (?, ?, ?, ?, ?, ?, ?, NOW(), FALSE)",[t,n.related_product_id,n.product_pricing_option_id,r.name,r.image_url,u,a]),_=`Промокод "${n.code}" успешно применен! Товар "${r.name}" (${o.duration_days} дн.${o.mode_label?`, ${o.mode_label}`:""}) добавлен в ваш инвентарь.`}await (0,p.P)("UPDATE promo_codes SET current_uses = current_uses + 1 WHERE id = ?",[n.id]),await (0,p.P)("INSERT INTO user_promo_code_uses (user_id, promo_code_id) VALUES (?, ?)",[t,n.id]);let m=(await (0,p.P)("SELECT * FROM users WHERE id = ?",[t]))[0];return m&&(m.balance=parseFloat(m.balance),m.referral_percentage=parseFloat(m.referral_percentage)),i.NextResponse.json({message:_,updatedUser:m},{status:200})}catch(t){console.error("API PromoCode Apply Error:",t);let e="Произошла внутренняя ошибка сервера при применении промокода.";return"ER_DUP_ENTRY"===t.code&&t.sqlMessage?.includes("uq_user_promo_code")&&(e="Вы уже активировали данный промокод."),i.NextResponse.json({message:e,error:t.message},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/promocode/apply/route",pathname:"/api/promocode/apply",filename:"route",bundlePath:"app/api/promocode/apply/route"},resolvedPagePath:"/var/www/html/src/app/api/promocode/apply/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:d,workUnitAsyncStorage:m,serverHooks:g}=_;function f(){return(0,n.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:m})}},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},79646:e=>{e.exports=require("child_process")},81630:e=>{e.exports=require("http")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,6724,5482,580,9526,4800],()=>r(57386));module.exports=s})();