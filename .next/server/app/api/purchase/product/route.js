"use strict";(()=>{var e={};e.id=6471,e.ids=[6471],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:e=>{e.exports=require("process")},21111:(e,t,r)=>{r.d(t,{BR:()=>c,Gf:()=>p,Q7:()=>u});var s=r(49526),a=r(75365);async function o(){try{let e=await (0,a.P)("SELECT * FROM site_smtp_settings WHERE id = ? LIMIT 1",[1]);if(e.length>0)return e[0];return null}catch(e){return console.error("Error fetching SMTP settings for email:",e),null}}async function n(){try{let e=await (0,a.P)("SELECT * FROM site_notification_settings WHERE id = ? LIMIT 1",[1]);if(e.length>0){let t=e[0];return{id:t.id,notify_on_registration:!!t.notify_on_registration,notify_on_balance_deposit:!!t.notify_on_balance_deposit,notify_on_product_purchase:!!t.notify_on_product_purchase,notify_on_support_reply:!!t.notify_on_support_reply,notify_on_software_activation:!!t.notify_on_software_activation,notify_on_license_expiry_soon:!!t.notify_on_license_expiry_soon,notify_on_promotions:!!t.notify_on_promotions,updated_at:t.updated_at}}return null}catch(e){return console.error("Error fetching notification settings for email:",e),null}}async function i(e){let t=await o();if(!t||!t.smtp_host||!t.smtp_port||!t.from_email)return console.error("Email Service: SMTP settings are incomplete or not found."),{success:!1,message:"SMTP settings are incomplete."};let r={host:t.smtp_host,port:Number(t.smtp_port),secure:465===Number(t.smtp_port)||"ssl"===t.smtp_encryption,auth:t.smtp_username&&t.smtp_password?{user:t.smtp_username,pass:t.smtp_password}:void 0};"tls"===t.smtp_encryption&&465!==Number(t.smtp_port)?(r.secure=!1,r.requireTLS=!0):"none"===t.smtp_encryption&&465!==Number(t.smtp_port)&&(r.secure=!1,r.ignoreTLS=!0);let a=s.createTransport(r);try{return await a.verify(),console.log(`Email Service: Sending email to ${e.to} with subject "${e.subject}"`),await a.sendMail({from:`"${t.from_name||"Green Hack"}" <${t.from_email}>`,...e}),{success:!0,message:`Email sent successfully to ${e.to}`}}catch(e){return console.error("Email Service: Error sending email:",e),{success:!1,message:`Failed to send email: ${e.message}`,error:e}}}async function p(e,t){let r=await n();if(!r?.notify_on_registration){console.log("Email Service: Registration notifications are disabled.");return}await i({to:e,subject:`Добро пожаловать на Green Hacks, ${t}!`,text:`Привет, ${t}!

Спасибо за регистрацию на Green Hacks. Ваш аккаунт успешно создан.

С уважением,
Команда Green Hacks`,html:`<p>Привет, ${t}!</p><p>Спасибо за регистрацию на <strong>Green Hacks</strong>. Ваш аккаунт успешно создан.</p><p>С уважением,<br/>Команда Green Hacks</p>`})}async function c(e,t,r,s,a){let o=await n();if(!o?.notify_on_product_purchase){console.log("Email Service: Product purchase notifications are disabled.");return}let p=s?` (на ${s} дн.)`:"";await i({to:e,subject:"Подтверждение покупки на Green Hacks",text:`Привет, ${t}!

Вы успешно приобрели "${r}${p}" за ${a.toFixed(2)} GH.

Товар добавлен в ваш инвентарь.

С уважением,
Команда Green Hacks`,html:`<p>Привет, ${t}!</p><p>Вы успешно приобрели "<strong>${r}${p}</strong>" за <strong>${a.toFixed(2)} GH</strong>.</p><p>Товар добавлен в ваш инвентарь.</p><p>С уважением,<br/>Команда Green Hacks</p>`})}async function u(e,t,r,s,a){let o=await n();if(!o?.notify_on_balance_deposit){console.log("Email Service: Balance update notifications are disabled.");return}let p=r>0?"пополнен":"изменен",c=r>0?`+${r.toFixed(2)} GH`:`${r.toFixed(2)} GH`;await i({to:e,subject:`Обновление баланса на Green Hacks`,text:`Привет, ${t}!

Ваш баланс был ${p} на ${c}. Причина: ${s}.
Новый баланс: ${a.toFixed(2)} GH.

С уважением,
Команда Green Hacks`,html:`<p>Привет, ${t}!</p><p>Ваш баланс был ${p} на <strong>${c}</strong>. Причина: ${s}.</p><p>Новый баланс: <strong>${a.toFixed(2)} GH</strong>.</p><p>С уважением,<br/>Команда Green Hacks</p>`})}},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},37366:e=>{e.exports=require("dns")},37480:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>d,serverHooks:()=>g,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{POST:()=>l});var a=r(96559),o=r(48088),n=r(37719),i=r(32190),p=r(75365),c=r(21111),u=r(42192);async function l(e){try{let{userId:t,productId:r,productPricingOptionId:s}=await e.json();if(!t||!r||!s)return i.NextResponse.json({message:"Missing required fields"},{status:400});let a=await (0,p.P)("SELECT * FROM users WHERE id = ?",[t]);if(0===a.length)return i.NextResponse.json({message:"User not found"},{status:404});let o=a[0],n="string"==typeof o.balance?parseFloat(o.balance):o.balance,l=o.referred_by_user_id,d=o.username,_=await (0,p.P)("SELECT * FROM product_pricing_options WHERE id = ? AND product_id = ?",[s,r]);if(0===_.length)return i.NextResponse.json({message:"Pricing option not found or does not match product"},{status:404});let m={..._[0],price_rub:parseFloat(_[0].price_rub),price_gh:parseFloat(_[0].price_gh),mode_label:_[0].mode_label};if(n<m.price_gh)return i.NextResponse.json({message:`Недостаточно средств. Требуется ${m.price_gh.toFixed(2)} GH.`,currentBalance:n.toFixed(2)},{status:402});let g=await (0,p.P)("SELECT name, image_url FROM products WHERE id = ?",[r]);if(0===g.length)return i.NextResponse.json({message:"Product details not found for inventory logging."},{status:404});let f=g[0],h=f.name,E=f.image_url||null,x=n-m.price_gh;await (0,p.P)("UPDATE users SET balance = ? WHERE id = ?",[x.toFixed(2),t]);let y=(await (0,p.P)("INSERT INTO balance_transactions (user_id, transaction_type, amount_gh, description) VALUES (?, ?, ?, ?)",[t,"purchase_product",-m.price_gh,`Покупка товара: ${h} (${m.duration_days} дн.${m.mode_label?`, ${m.mode_label}`:""})`])).insertId,$=(await (0,p.P)("INSERT INTO purchases (user_id, product_id, product_pricing_option_id, amount_paid_gh, status, balance_transaction_id) VALUES (?, ?, ?, ?, ?, ?)",[t,r,m.id,m.price_gh,"completed",y])).insertId,b=null;if(m.duration_days){let e=new Date;e.setDate(e.getDate()+m.duration_days),b=e.toISOString().slice(0,19).replace("T"," ")}let w=`GH-PROD-${Date.now().toString().slice(-6)}`;await (0,p.P)("INSERT INTO user_inventory (user_id, related_product_id, product_pricing_option_id, product_name, product_image_url, activation_code, expires_at, acquired_at, is_used, purchase_id) VALUES (?, ?, ?, ?, ?, ?, ?, NOW(), FALSE, ?)",[t,r,s,h,E,w,b,$]);let S=null;if(l){let e=await (0,p.P)("SELECT referral_percentage FROM users WHERE id = ?",[l]);if(e.length>0){let r=parseFloat(e[0].referral_percentage||"5.00"),s=m.price_gh*(r/100);s>0&&(await (0,p.P)("UPDATE users SET balance = balance + ? WHERE id = ?",[s.toFixed(2),l]),S=(await (0,p.P)("INSERT INTO balance_transactions (user_id, transaction_type, amount_gh, description) VALUES (?, ?, ?, ?)",[l,"referral_bonus",s.toFixed(2),`Бонус за покупку реферала: ${d} (${h})`])).insertId,await (0,p.P)("UPDATE referrals SET status = ?, reward_amount_gh = ?, reward_claimed_at = NOW(), reward_description = ?, related_balance_transaction_id = ? WHERE referred_user_id = ? AND referrer_user_id = ? AND status = ?",["completed",s.toFixed(2),`Покупка: ${h} (${m.duration_days} дн.${m.mode_label?`, ${m.mode_label}`:""})`,S,t,l,"pending_purchase"]))}}let R=(await (0,p.P)("SELECT * FROM users WHERE id = ?",[t]))[0];R&&(R.balance=parseFloat(R.balance),R.referral_percentage=parseFloat(R.referral_percentage));try{let e=await (0,p.P)("SELECT notify_on_product_purchase FROM site_notification_settings WHERE id = ? LIMIT 1",[1]);e.length>0&&e[0].notify_on_product_purchase&&await (0,c.BR)(o.email,o.username,h,m.duration_days,m.price_gh)}catch(e){console.error("Failed to send purchase confirmation email:",e)}try{await (0,u.A6)(o.id,o.username,h,m.duration_days,m.price_gh)}catch(e){console.error("Failed to send Telegram admin notification for product purchase:",e)}return i.NextResponse.json({message:`Покупка "${h}" (${m.duration_days} дн.${m.mode_label?`, ${m.mode_label}`:""}) успешна!`,updatedUser:R},{status:200})}catch(e){return console.error("API Product Purchase Error:",e),i.NextResponse.json({message:`Internal Server Error: ${e.message}`},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/purchase/product/route",pathname:"/api/purchase/product",filename:"route",bundlePath:"app/api/purchase/product/route"},resolvedPagePath:"/var/www/html/src/app/api/purchase/product/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:_,workUnitAsyncStorage:m,serverHooks:g}=d;function f(){return(0,n.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:m})}},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},79646:e=>{e.exports=require("child_process")},81630:e=>{e.exports=require("http")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,6724,5482,580,9526,4800],()=>r(37480));module.exports=s})();