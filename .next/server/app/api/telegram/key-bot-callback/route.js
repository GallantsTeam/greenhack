"use strict";(()=>{var e={};e.id=233,e.ids=[233],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:e=>{e.exports=require("process")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55309:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>g,routeModule:()=>c,serverHooks:()=>m,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>_});var a={};r.r(a),r.d(a,{POST:()=>l});var s=r(96559),o=r(48088),i=r(37719),n=r(32190),u=r(75365),d=r(42192);async function l(e){try{let t=await e.json();console.log("[API KeyBot Callback] Received callback data:",t);let r=t.callback_query;if(!r||!r.data||!r.message||!r.message.chat||!r.from)return console.error("[API KeyBot Callback] Invalid callback_query structure"),n.NextResponse.json({message:"Invalid callback query structure."},{status:200});r.from.id;let a=r.from.username||r.from.first_name||"Администратор",[s,o]=r.data.split(":"),i=parseInt(o,10),l=r.message.chat.id,c=process.env.TELEGRAM_KEY_BOT_TOKEN;if(!c)return console.error("[API KeyBot Callback] TELEGRAM_KEY_BOT_TOKEN is not set in environment variables."),n.NextResponse.json({message:"Server configuration error for key bot."},{status:200});if(isNaN(i)||"activate_key"!==s&&"reject_key"!==s)return console.error(`[API KeyBot Callback] Invalid action or inventoryItemId: ${r.data}`),await (0,d.V5)(c,l.toString(),"Ошибка: Неверные данные в callback.","MarkdownV2"),n.NextResponse.json({message:"Invalid action or item ID."},{status:200});let p=await (0,u.P)(`SELECT 
         ui.*, 
         p.name as product_name_from_product, 
         COALESCE(ppo.duration_days, cp.duration_days) as resolved_duration_days,
         u.id as user_db_id, u.username as user_db_username, u.email as user_email, u.telegram_id as user_telegram_id
       FROM user_inventory ui
       LEFT JOIN products p ON ui.related_product_id = p.id
       LEFT JOIN product_pricing_options ppo ON ui.product_pricing_option_id = ppo.id
       LEFT JOIN case_prizes cp ON ui.case_prize_id = cp.id
       LEFT JOIN users u ON ui.user_id = u.id
       WHERE ui.id = ?`,[i]);if(0===p.length)return console.error(`[API KeyBot Callback] Inventory item ${i} not found.`),await (0,d.V5)(c,l.toString(),`Ошибка: Предмет инвентаря с ID ${i} не найден.`,"MarkdownV2"),n.NextResponse.json({message:"Inventory item not found."},{status:200});let _=p[0];_.product_name=_.product_name||_.product_name_from_product||"Неизвестный продукт",_.duration_days=_.resolved_duration_days?parseInt(_.resolved_duration_days,10):null;let m=_.activation_status,g="",y="";if("pending_admin_approval"!==_.activation_status)y=`Заявка для предмета \`${escapeTelegramMarkdownV2(_.product_name)}\` \\(ID: ${i}\\) уже была обработана админом @${escapeTelegramMarkdownV2(r.from.username||r.from.first_name)}\\. Статус: \`${_.activation_status}\``;else if("activate_key"===s){m="active";let e=null,t=new Date;if(_.duration_days&&_.duration_days>0){let r=new Date(t);r.setDate(r.getDate()+_.duration_days),e=r.toISOString().slice(0,19).replace("T"," ")}await (0,u.P)("UPDATE user_inventory SET activation_status = ?, is_used = TRUE, activated_at = ?, expires_at = ?, updated_at = NOW() WHERE id = ?",[m,t.toISOString().slice(0,19).replace("T"," "),e,i]),g=`✅ Ваш ключ для "${_.product_name}"${_.duration_days?` на ${_.duration_days} дн.`:""} успешно активирован!`,e&&(g+=`
Истекает: ${new Date(e).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}`),y=`✅ Ключ для \`${escapeTelegramMarkdownV2(_.product_name)}\` \\(Инв\\. ID: ${i}\\) активирован админом @${escapeTelegramMarkdownV2(a)}\\.`}else"reject_key"===s&&(m="rejected",await (0,u.P)("UPDATE user_inventory SET activation_status = ?, updated_at = NOW() WHERE id = ?",[m,i]),g=`❌ Ваш запрос на активацию ключа для "${_.product_name}" был отклонен. Пожалуйста, проверьте ключ или обратитесь в поддержку.`,y=`❌ Запрос на активацию ключа для \`${escapeTelegramMarkdownV2(_.product_name)}\` \\(Инв\\. ID: ${i}\\) отклонен админом @${escapeTelegramMarkdownV2(a)}\\.`);let k=r.message.text,v=`${k}

---
*${y}*`;if(await fetch(`https://api.telegram.org/bot${c}/editMessageText`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:r.message.chat.id,message_id:r.message.message_id,text:v,parse_mode:"MarkdownV2",reply_markup:{inline_keyboard:[]}})}),g&&_.user_telegram_id){let e=await getTelegramSettings(),t=e?.telegramSettings?.client_bot_token;t?await (0,d.V5)(t,_.user_telegram_id,g,"MarkdownV2"):console.warn(`[API KeyBot Callback] Client Bot token not configured. Cannot send notification to user ${_.user_id}.`)}else g&&!_.user_telegram_id&&_.user_email&&console.log(`[API KeyBot Callback] User ${_.user_id} does not have a Telegram ID. Activation status: ${m}. Attempting email notification.`);return n.NextResponse.json({message:"Callback processed."},{status:200})}catch(e){return console.error("[API KeyBot Callback] Error:",e),n.NextResponse.json({message:"Error processing callback."},{status:200})}}let c=new s.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/telegram/key-bot-callback/route",pathname:"/api/telegram/key-bot-callback",filename:"route",bundlePath:"app/api/telegram/key-bot-callback/route"},resolvedPagePath:"/var/www/html/src/app/api/telegram/key-bot-callback/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:p,workUnitAsyncStorage:_,serverHooks:m}=c;function g(){return(0,i.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:_})}},55511:e=>{e.exports=require("crypto")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4447,6724,5482,580,4800],()=>r(55309));module.exports=a})();