"use strict";(()=>{var e={};e.id=1142,e.ids=[1142],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:e=>{e.exports=require("process")},21111:(e,t,o)=>{o.d(t,{BR:()=>c,Gf:()=>p,Q7:()=>u});var s=o(49526),n=o(75365);async function r(){try{let e=await (0,n.P)("SELECT * FROM site_smtp_settings WHERE id = ? LIMIT 1",[1]);if(e.length>0)return e[0];return null}catch(e){return console.error("Error fetching SMTP settings for email:",e),null}}async function i(){try{let e=await (0,n.P)("SELECT * FROM site_notification_settings WHERE id = ? LIMIT 1",[1]);if(e.length>0){let t=e[0];return{id:t.id,notify_on_registration:!!t.notify_on_registration,notify_on_balance_deposit:!!t.notify_on_balance_deposit,notify_on_product_purchase:!!t.notify_on_product_purchase,notify_on_support_reply:!!t.notify_on_support_reply,notify_on_software_activation:!!t.notify_on_software_activation,notify_on_license_expiry_soon:!!t.notify_on_license_expiry_soon,notify_on_promotions:!!t.notify_on_promotions,updated_at:t.updated_at}}return null}catch(e){return console.error("Error fetching notification settings for email:",e),null}}async function a(e){let t=await r();if(!t||!t.smtp_host||!t.smtp_port||!t.from_email)return console.error("Email Service: SMTP settings are incomplete or not found."),{success:!1,message:"SMTP settings are incomplete."};let o={host:t.smtp_host,port:Number(t.smtp_port),secure:465===Number(t.smtp_port)||"ssl"===t.smtp_encryption,auth:t.smtp_username&&t.smtp_password?{user:t.smtp_username,pass:t.smtp_password}:void 0};"tls"===t.smtp_encryption&&465!==Number(t.smtp_port)?(o.secure=!1,o.requireTLS=!0):"none"===t.smtp_encryption&&465!==Number(t.smtp_port)&&(o.secure=!1,o.ignoreTLS=!0);let n=s.createTransport(o);try{return await n.verify(),console.log(`Email Service: Sending email to ${e.to} with subject "${e.subject}"`),await n.sendMail({from:`"${t.from_name||"Green Hack"}" <${t.from_email}>`,...e}),{success:!0,message:`Email sent successfully to ${e.to}`}}catch(e){return console.error("Email Service: Error sending email:",e),{success:!1,message:`Failed to send email: ${e.message}`,error:e}}}async function p(e,t){let o=await i();if(!o?.notify_on_registration){console.log("Email Service: Registration notifications are disabled.");return}await a({to:e,subject:`Добро пожаловать на Green Hacks, ${t}!`,text:`Привет, ${t}!

Спасибо за регистрацию на Green Hacks. Ваш аккаунт успешно создан.

С уважением,
Команда Green Hacks`,html:`<p>Привет, ${t}!</p><p>Спасибо за регистрацию на <strong>Green Hacks</strong>. Ваш аккаунт успешно создан.</p><p>С уважением,<br/>Команда Green Hacks</p>`})}async function c(e,t,o,s,n){let r=await i();if(!r?.notify_on_product_purchase){console.log("Email Service: Product purchase notifications are disabled.");return}let p=s?` (на ${s} дн.)`:"";await a({to:e,subject:"Подтверждение покупки на Green Hacks",text:`Привет, ${t}!

Вы успешно приобрели "${o}${p}" за ${n.toFixed(2)} GH.

Товар добавлен в ваш инвентарь.

С уважением,
Команда Green Hacks`,html:`<p>Привет, ${t}!</p><p>Вы успешно приобрели "<strong>${o}${p}</strong>" за <strong>${n.toFixed(2)} GH</strong>.</p><p>Товар добавлен в ваш инвентарь.</p><p>С уважением,<br/>Команда Green Hacks</p>`})}async function u(e,t,o,s,n){let r=await i();if(!r?.notify_on_balance_deposit){console.log("Email Service: Balance update notifications are disabled.");return}let p=o>0?"пополнен":"изменен",c=o>0?`+${o.toFixed(2)} GH`:`${o.toFixed(2)} GH`;await a({to:e,subject:`Обновление баланса на Green Hacks`,text:`Привет, ${t}!

Ваш баланс был ${p} на ${c}. Причина: ${s}.
Новый баланс: ${n.toFixed(2)} GH.

С уважением,
Команда Green Hacks`,html:`<p>Привет, ${t}!</p><p>Ваш баланс был ${p} на <strong>${c}</strong>. Причина: ${s}.</p><p>Новый баланс: <strong>${n.toFixed(2)} GH</strong>.</p><p>С уважением,<br/>Команда Green Hacks</p>`})}},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},37366:e=>{e.exports=require("dns")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55218:(e,t,o)=>{o.r(t),o.d(t,{patchFetch:()=>f,routeModule:()=>l,serverHooks:()=>_,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>m});var s={};o.r(s),o.d(s,{POST:()=>d});var n=o(96559),r=o(48088),i=o(37719),a=o(32190),p=o(75365),c=o(21111),u=o(42192);async function d(e){let t;let o=await e.text();try{t=JSON.parse(o)}catch(e){return console.error("[YooMoney Webhook] Invalid JSON body:",o),a.NextResponse.json({message:"Invalid JSON body"},{status:400})}console.log("[YooMoney Webhook] Received notification:",JSON.stringify(t,null,2));let s=t.event,n=t.object;if(!s||!n||!n.id)return console.error("[YooMoney Webhook] Invalid notification structure:",t),a.NextResponse.json({message:"Invalid notification structure"},{status:400});let r=n.id,i=n.metadata?.paymentRequestId;try{let e=await (0,p.P)("SELECT * FROM site_payment_gateway_settings WHERE id = ? LIMIT 1",[1]);if(!e||0===e.length)return console.error("[YooMoney Webhook] Site payment gateway settings not found."),a.NextResponse.json({message:"Internal configuration error."},{status:500});let t={...e[0],is_test_mode_active:!!e[0].is_test_mode_active};if(t.is_test_mode_active)return console.log("[YooMoney Webhook] Test mode is active. Webhook processing skipped for live payment simulation logic."),a.NextResponse.json({message:"Webhook received in test mode. No balance updated."},{status:200});let o=await (0,p.P)("SELECT * FROM payment_requests WHERE id = ? AND external_payment_id = ?",[i,r]);if(0===o.length)return console.error(`[YooMoney Webhook] PaymentRequest not found for ID: ${i} and External ID: ${r}`),a.NextResponse.json({message:"Original payment request not found or ID mismatch."},{status:404});let d=o[0];if("payment.succeeded"===s){if(!t.yoomoney_notify_payment_succeeded)return console.log("[YooMoney Webhook] payment.succeeded notification type is disabled in settings. Skipping."),a.NextResponse.json({message:"Notification type disabled."},{status:200});if("approved"===d.status)return console.log(`[YooMoney Webhook] PaymentRequest ID ${i} already approved. Idempotency.`),a.NextResponse.json({message:"Payment already processed."},{status:200});"pending_yoomoney"!==d.status&&console.warn(`[YooMoney Webhook] PaymentRequest ID ${i} has unexpected status: ${d.status}`);let e=parseFloat(n.amount.value),o=parseFloat(d.amount_gh);if(e!==o)return console.error(`[YooMoney Webhook] Amount mismatch for PaymentRequest ID ${i}. YooMoney: ${e}, DB: ${o}`),await (0,p.P)("UPDATE payment_requests SET status = ?, admin_notes = ? WHERE id = ?",["failed",`Сумма не совпадает. YooMoney: ${e}, Ожидалось: ${o}`,i]),a.NextResponse.json({message:"Amount mismatch."},{status:400});try{let t=await (0,p.P)("SELECT * FROM users WHERE id = ?",[d.user_id]);if(0===t.length)throw Error(`User ${d.user_id} not found for payment.`);let o=t[0],s=parseFloat(o.balance||"0")+e;await (0,p.P)("UPDATE users SET balance = ? WHERE id = ?",[s.toFixed(2),d.user_id]);let n=`Пополнение через YooMoney. ID платежа: ${r}. Заявка #${i}.`;await (0,p.P)("INSERT INTO balance_transactions (user_id, transaction_type, amount_gh, description, related_payment_request_id) VALUES (?, ?, ?, ?, ?)",[d.user_id,"deposit",e,n,i]),await (0,p.P)("UPDATE payment_requests SET status = ?, updated_at = NOW() WHERE id = ?",["approved",i]);try{let t=await (0,p.P)("SELECT notify_on_balance_deposit FROM site_notification_settings WHERE id = ? LIMIT 1",[1]);t.length>0&&t[0].notify_on_balance_deposit&&await (0,c.Q7)(o.email,o.username,e,`YooMoney: ${r}`,s)}catch(e){console.error("[YooMoney Webhook] Failed to send email notification:",e)}try{await (0,u._q)(o.id,o.username,e,`YooMoney: ${r}`)}catch(e){console.error("[YooMoney Webhook] Failed to send Telegram admin notification:",e)}}catch(e){return console.error("[YooMoney Webhook] DB Error during payment.succeeded processing:",e),a.NextResponse.json({message:`DB error processing webhook: ${e.message}`},{status:500})}}else if("payment.canceled"===s){if(!t.yoomoney_notify_payment_canceled)return console.log("[YooMoney Webhook] payment.canceled notification type is disabled in settings. Skipping."),a.NextResponse.json({message:"Notification type disabled."},{status:200});"pending_yoomoney"===d.status&&await (0,p.P)("UPDATE payment_requests SET status = ?, admin_notes = ?, updated_at = NOW() WHERE id = ?",["rejected","Платеж отменен или не прошел в YooMoney.",i])}else if("refund.succeeded"===s){if(!t.yoomoney_notify_refund_succeeded)return console.log("[YooMoney Webhook] refund.succeeded notification type is disabled in settings. Skipping."),a.NextResponse.json({message:"Notification type disabled."},{status:200});console.log(`[YooMoney Webhook] Refund succeeded for YooMoney payment ID: ${r}, our request ID: ${i}`);let e=parseFloat(n.amount.value);await (0,p.P)("UPDATE payment_requests SET status = ?, admin_notes = CONCAT(COALESCE(admin_notes, ''), ?, \"Возврат через YooMoney на сумму \", ?) WHERE id = ?",["refunded",n.description?`Причина возврата: ${n.description}. `:"",e.toFixed(2),i])}else if("payment.waiting_for_capture"===s){if(!t.yoomoney_notify_payment_waiting_for_capture)return console.log("[YooMoney Webhook] payment.waiting_for_capture notification type is disabled in settings. Skipping."),a.NextResponse.json({message:"Notification type disabled."},{status:200});console.log(`[YooMoney Webhook] Payment waiting for capture for YooMoney payment ID: ${r}, our request ID: ${i}`)}else console.log(`[YooMoney Webhook] Unhandled event type: ${s}`);return a.NextResponse.json({message:"Webhook processed"},{status:200})}catch(e){return console.error("[YooMoney Webhook] Outer Error:",e),a.NextResponse.json({message:`Webhook processing error: ${e.message}`},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/payment/yoomoney-webhook/route",pathname:"/api/payment/yoomoney-webhook",filename:"route",bundlePath:"app/api/payment/yoomoney-webhook/route"},resolvedPagePath:"/var/www/html/src/app/api/payment/yoomoney-webhook/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:m,serverHooks:_}=l;function f(){return(0,i.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:m})}},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},79646:e=>{e.exports=require("child_process")},81630:e=>{e.exports=require("http")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),s=t.X(0,[4447,6724,5482,580,9526,4800],()=>o(55218));module.exports=s})();