(()=>{var e={};e.id=2938,e.ids=[2938],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:e=>{"use strict";e.exports=require("process")},27910:e=>{"use strict";e.exports=require("stream")},28303:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=28303,e.exports=t},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30035:(e,t,r)=>{"use strict";r.r(t),r.d(t,{"6089447028175c0572b15a7e03e70f832d763fe00d":()=>s.P});var s=r(75365)},34631:e=>{"use strict";e.exports=require("tls")},41204:e=>{"use strict";e.exports=require("string_decoder")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},75365:(e,t,r)=>{"use strict";r.d(t,{P:()=>c});var s=r(67218);r(79130);var o=r(46101),a=r(17478);let i={host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME,connectionLimit:10,namedPlaceholders:!0},n=null;async function c(e,t){let r;let s=function(){if(!n){if(!process.env.DB_HOST||!process.env.DB_USER||!process.env.DB_NAME)throw console.error("Database environment variables DB_HOST, DB_USER, or DB_NAME are not set."),Error("Database environment variables are not fully set. Please check your .env.local file.");try{n=o.createPool(i),console.log("MySQL connection pool created successfully."),n.getConnection().then(e=>{console.log("Successfully connected to database via pool."),e.release()}).catch(e=>{console.error("Failed to get a connection from pool on startup:",e)})}catch(e){throw console.error("Failed to create MySQL connection pool:",e),n=null,Error("Database connection pool could not be created.")}}return n}();try{r=await s.getConnection(),console.log(`Executing SQL: ${e} with params: ${t?JSON.stringify(t):"No params"}`);let[o]=await r.execute(e,t);return o}catch(e){throw console.error("Database query error:",e.message,e.code,e.sqlMessage,e.sql),Error(`Database query failed: ${e.message}`)}finally{r&&r.release()}}(0,a.D)([c]),(0,s.A)(c,"6089447028175c0572b15a7e03e70f832d763fe00d",null)},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{},97313:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>v,routeModule:()=>l,serverHooks:()=>_,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>p});var s={};r.r(s),r.d(s,{POST:()=>u});var o=r(96559),a=r(48088),i=r(37719),n=r(32190),c=r(75365);async function u(e){try{let{userId:t,inventoryItemId:r}=await e.json();if(console.log("[API Activate] Received request:",{userId:t,inventoryItemId:r}),!t||!r)return console.log("[API Activate] Missing userId or inventoryItemId"),n.NextResponse.json({message:"Missing userId or inventoryItemId"},{status:400});let s=await (0,c.P)(`SELECT 
         ui.*,
         COALESCE(ppo.duration_days, cp.duration_days) as resolved_duration_days,
         ppo.mode_label as pricing_option_mode_label,
         cp.mode_label as case_prize_mode_label -- If case_prizes table also has mode_label
       FROM user_inventory ui
       LEFT JOIN product_pricing_options ppo ON ui.product_pricing_option_id = ppo.id
       LEFT JOIN case_prizes cp ON ui.case_prize_id = cp.id
       WHERE ui.id = ? AND ui.user_id = ?`,[r,t]);if(0===s.length)return console.log(`[API Activate] Item not found for user ${t}, item ID ${r}`),n.NextResponse.json({message:"Предмет не найден в инвентаре или не принадлежит вам."},{status:404});let o=s[0];console.log("[API Activate] Found item in DB:",o);let a={...o,is_used:!!o.is_used,duration_days:o.resolved_duration_days?parseInt(o.resolved_duration_days,10):null,mode_label:o.pricing_option_mode_label||o.case_prize_mode_label||null,activation_status:o.activation_status||"available"};if(a.is_used)return console.log(`[API Activate] Item ${r} already used.`),n.NextResponse.json({message:"Этот предмет уже был активирован."},{status:400});if(!a.related_product_id&&a.case_prize_id)return console.log(`[API Activate] Item ${r} is a non-product prize (e.g., balance), marking as used.`),await (0,c.P)("UPDATE user_inventory SET is_used = TRUE, activated_at = NOW() WHERE id = ?",[r]),n.NextResponse.json({message:`${a.product_name} помечен как использованный.`},{status:200});if(!a.related_product_id)return console.log(`[API Activate] Item ${r} has no related_product_id and is not a direct case_prize_id activation. Cannot determine license type.`),n.NextResponse.json({message:"Невозможно активировать этот тип предмета как лицензию (отсутствует ID продукта)."},{status:400});let i=null,u=new Date;if(console.log(`[API Activate] Item duration_days: ${a.duration_days}`),a.duration_days&&a.duration_days>0){let e=new Date(u);e.setDate(e.getDate()+a.duration_days),i=e.toISOString().slice(0,19).replace("T"," "),console.log(`[API Activate] Calculated expiresAt: ${i}`)}else console.log("[API Activate] No duration or duration is 0, expiresAt will be NULL (permanent).");return await (0,c.P)("UPDATE user_inventory SET is_used = TRUE, activated_at = ?, expires_at = ? WHERE id = ?",[u.toISOString().slice(0,19).replace("T"," "),i,r]),console.log(`[API Activate] Item ${r} updated successfully.`),n.NextResponse.json({message:`${a.product_name} успешно активирован!`},{status:200})}catch(e){return console.error("[API Inventory Activate Error]:",e),n.NextResponse.json({message:`Internal Server Error: ${e.message}`},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/inventory/activate/route",pathname:"/api/inventory/activate",filename:"route",bundlePath:"app/api/inventory/activate/route"},resolvedPagePath:"/var/www/html/src/app/api/inventory/activate/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:d,workUnitAsyncStorage:p,serverHooks:_}=l;function v(){return(0,i.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:p})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,6724,5482,580],()=>r(97313));module.exports=s})();