(()=>{var e={};e.id=4889,e.ids=[4889],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:e=>{"use strict";e.exports=require("process")},27910:e=>{"use strict";e.exports=require("stream")},28303:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=28303,e.exports=r},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30035:(e,r,t)=>{"use strict";t.r(r),t.d(r,{"6089447028175c0572b15a7e03e70f832d763fe00d":()=>s.P});var s=t(75365)},34631:e=>{"use strict";e.exports=require("tls")},41204:e=>{"use strict";e.exports=require("string_decoder")},42053:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>g,routeModule:()=>p,serverHooks:()=>f,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>m});var s={};t.r(s),t.d(s,{GET:()=>u,POST:()=>d,dynamic:()=>l});var a=t(96559),n=t(48088),o=t(37719),i=t(32190),c=t(75365);let l="force-dynamic";async function u(e){try{let e=await (0,c.P)(`SELECT
         c.id,
         c.name,
         c.image_url,
         c.base_price_gh,
         c.description,
         c.data_ai_hint,
         c.is_active,
         c.is_hot_offer,
         c.timer_enabled,
         c.timer_ends_at,
         c.created_at,
         (SELECT COUNT(*) FROM case_prizes cp WHERE cp.case_id = c.id) as prize_count
       FROM cases c
       ORDER BY c.name ASC`);if(!Array.isArray(e))return console.error("API Admin Cases GET Error: Expected an array from database query, received:",e),i.NextResponse.json({message:"Failed to retrieve cases: unexpected database response format."},{status:500});let r=e.map(e=>({id:e.id,name:e.name,image_url:e.image_url?String(e.image_url).trim():null,imageUrl:e.image_url?String(e.image_url).trim():`https://placehold.co/300x200.png?text=${encodeURIComponent(e.name)}`,base_price_gh:null===e.base_price_gh||isNaN(parseFloat(String(e.base_price_gh)))?0:parseFloat(String(e.base_price_gh)),description:e.description?String(e.description):null,data_ai_hint:e.data_ai_hint?String(e.data_ai_hint):null,is_active:!!e.is_active,is_hot_offer:!!e.is_hot_offer,timer_enabled:!!e.timer_enabled,timer_ends_at:e.timer_ends_at?new Date(e.timer_ends_at).toISOString():null,created_at:e.created_at,prize_count:null===e.prize_count||isNaN(parseInt(String(e.prize_count)))?0:parseInt(String(e.prize_count))}));return i.NextResponse.json(r)}catch(r){console.error("API Admin Cases GET Error (Full Error Object):",r);let e=r.message||"An unknown error occurred on the server.";return i.NextResponse.json({message:`Internal Server Error: ${e}`},{status:500})}}async function d(e){try{let{id:r,name:t,image_url:s,base_price_gh:a,description:n,data_ai_hint:o,is_active:l,is_hot_offer:u,timer_enabled:d,timer_ends_at:p}=await e.json();if(!r||!t||"number"!=typeof a)return i.NextResponse.json({message:"ID, Название и Базовая цена обязательны."},{status:400});let _=await (0,c.P)("SELECT id FROM cases WHERE id = ?",[r]);if(Array.isArray(_)&&_.length>0)return i.NextResponse.json({message:"Кейс с таким ID уже существует."},{status:409});let m=null;if(d&&p)try{m=new Date(p).toISOString().slice(0,19).replace("T"," ")}catch(e){console.warn("Invalid date format for timer_ends_at on create:",p)}let f=`
      INSERT INTO cases (
        id, name, image_url, base_price_gh, description, data_ai_hint, 
        is_active, is_hot_offer, timer_enabled, timer_ends_at, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())
    `,g=[r,t,s||null,a,n||null,o||null,void 0===l||!!l,void 0!==u&&!!u,void 0!==d&&!!d,m],v=await (0,c.P)(f,g),h=0;if(Array.isArray(v)&&v.length>0&&"affectedRows"in v[0]?h=v[0].affectedRows:v&&"affectedRows"in v&&(h=v.affectedRows),!(h>0))return console.error("Case creation in DB failed:",v),i.NextResponse.json({message:"Не удалось создать кейс в базе данных."},{status:500});{let e=await (0,c.P)("SELECT * FROM cases WHERE id = ?",[r]),t={...e[0],is_active:!!e[0].is_active,is_hot_offer:!!e[0].is_hot_offer,timer_enabled:!!e[0].timer_enabled,timer_ends_at:e[0].timer_ends_at?new Date(e[0].timer_ends_at).toISOString():null,prize_count:0};return i.NextResponse.json({message:"Кейс успешно создан",caseItem:t},{status:201})}}catch(e){return console.error("API Admin Cases POST Error:",e),i.NextResponse.json({message:`Внутренняя ошибка сервера: ${e.message}`},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/admin/cases/route",pathname:"/api/admin/cases",filename:"route",bundlePath:"app/api/admin/cases/route"},resolvedPagePath:"/var/www/html/src/app/api/admin/cases/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:_,workUnitAsyncStorage:m,serverHooks:f}=p;function g(){return(0,o.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:m})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},75365:(e,r,t)=>{"use strict";t.d(r,{P:()=>c});var s=t(67218);t(79130);var a=t(46101),n=t(17478);let o={host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME,connectionLimit:10,namedPlaceholders:!0},i=null;async function c(e,r){let t;let s=function(){if(!i){if(!process.env.DB_HOST||!process.env.DB_USER||!process.env.DB_NAME)throw console.error("Database environment variables DB_HOST, DB_USER, or DB_NAME are not set."),Error("Database environment variables are not fully set. Please check your .env.local file.");try{i=a.createPool(o),console.log("MySQL connection pool created successfully."),i.getConnection().then(e=>{console.log("Successfully connected to database via pool."),e.release()}).catch(e=>{console.error("Failed to get a connection from pool on startup:",e)})}catch(e){throw console.error("Failed to create MySQL connection pool:",e),i=null,Error("Database connection pool could not be created.")}}return i}();try{t=await s.getConnection(),console.log(`Executing SQL: ${e} with params: ${r?JSON.stringify(r):"No params"}`);let[a]=await t.execute(e,r);return a}catch(e){throw console.error("Database query error:",e.message,e.code,e.sqlMessage,e.sql),Error(`Database query failed: ${e.message}`)}finally{t&&t.release()}}(0,n.D)([c]),(0,s.A)(c,"6089447028175c0572b15a7e03e70f832d763fe00d",null)},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4447,6724,5482,580],()=>t(42053));module.exports=s})();