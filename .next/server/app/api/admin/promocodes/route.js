"use strict";(()=>{var e={};e.id=2227,e.ids=[2227],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:e=>{e.exports=require("process")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},61694:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>g,routeModule:()=>_,serverHooks:()=>x,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>m});var o={};t.r(o),t.d(o,{GET:()=>c,POST:()=>u});var s=t(96559),a=t(48088),p=t(37719),i=t(32190),n=t(75365),d=t(42192);async function u(e){try{let r;let{code:t,type:o,value_gh:s,related_product_id:a,product_pricing_option_id:p,max_uses:u,expires_at:c,is_active:_}=await e.json();if(!t||!o||void 0===u)return i.NextResponse.json({message:"Код, тип и макс. использования обязательны."},{status:400});if("balance_gh"===o&&(null==s||s<=0))return i.NextResponse.json({message:'Для типа "Баланс GH" сумма должна быть больше 0.'},{status:400});if("product"===o&&(!a||null==p))return i.NextResponse.json({message:'Для типа "Товар" необходимо выбрать товар и вариант цены.'},{status:400});let l=await (0,n.P)("SELECT id FROM promo_codes WHERE code = ?",[t]);if(Array.isArray(l)&&l.length>0)return i.NextResponse.json({message:"Промокод с таким кодом уже существует."},{status:409});let m=`
      INSERT INTO promo_codes (
        code, type, value_gh, related_product_id, product_pricing_option_id,
        max_uses, expires_at, is_active, current_uses, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, NOW(), NOW())
    `,x=[t,o,"balance_gh"===o?s:null,"product"===o?a:null,"product"===o?p:null,u,c?new Date(c).toISOString().slice(0,19).replace("T"," "):null,void 0===_||!!_],g=await (0,n.P)(m,x);if(Array.isArray(g)&&g.length>0&&"insertId"in g[0]?r=g[0].insertId:g&&"insertId"in g&&(r=g.insertId),!r)return console.error("Promo code creation in DB failed, no insertId:",g),i.NextResponse.json({message:"Не удалось создать промокод в базе данных."},{status:500});{let e=(await (0,n.P)(`SELECT pc.*, p.name as product_name, ppo.duration_days, ppo.mode_label 
         FROM promo_codes pc 
         LEFT JOIN products p ON pc.related_product_id = p.id 
         LEFT JOIN product_pricing_options ppo ON pc.product_pricing_option_id = ppo.id 
         WHERE pc.id = ?`,[r]))[0];try{await (0,d.Fm)(null,{code:e.code,type:e.type,value_gh:e.value_gh?parseFloat(e.value_gh):null,product_name:e.product_name,duration_days:e.duration_days,mode_label:e.mode_label,max_uses:e.max_uses,expires_at:e.expires_at})}catch(e){console.error("Failed to send Telegram admin notification for promo code creation:",e)}return i.NextResponse.json({message:"Промокод успешно создан",promoCode:e},{status:201})}}catch(e){return console.error("API Admin PromoCodes POST Error:",e),i.NextResponse.json({message:`Внутренняя ошибка сервера: ${e.message}`},{status:500})}}async function c(e){try{let e=await (0,n.P)(`SELECT 
         pc.*,
         p.name as product_name,
         ppo.duration_days,
         ppo.price_rub,
         ppo.price_gh as option_price_gh,
         ppo.mode_label as pricing_option_mode_label 
       FROM promo_codes pc
       LEFT JOIN products p ON pc.related_product_id = p.id
       LEFT JOIN product_pricing_options ppo ON pc.product_pricing_option_id = ppo.id
       ORDER BY pc.created_at DESC`),r=new Date,t=[],o=[];return e.forEach(e=>{let s={id:e.id,code:e.code,type:e.type,value_gh:e.value_gh?parseFloat(e.value_gh):null,related_product_id:e.related_product_id,product_pricing_option_id:e.product_pricing_option_id,max_uses:e.max_uses,current_uses:e.current_uses,expires_at:e.expires_at?new Date(e.expires_at).toISOString():null,is_active:!!e.is_active,created_at:e.created_at,updated_at:e.updated_at,product_name:e.product_name,pricing_option_description:e.duration_days?`${e.duration_days} дн.`:void 0,pricing_option_mode_label:e.pricing_option_mode_label},a=!!s.expires_at&&new Date(s.expires_at)<r,p=s.current_uses>=s.max_uses;!s.is_active||a||p?o.push(s):t.push(s)}),i.NextResponse.json({activePromoCodes:t,usedOrExpiredPromoCodes:o})}catch(e){return console.error("API Admin PromoCodes GET Error:",e),i.NextResponse.json({message:`Внутренняя ошибка сервера: ${e.message}`},{status:500})}}let _=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/admin/promocodes/route",pathname:"/api/admin/promocodes",filename:"route",bundlePath:"app/api/admin/promocodes/route"},resolvedPagePath:"/var/www/html/src/app/api/admin/promocodes/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:l,workUnitAsyncStorage:m,serverHooks:x}=_;function g(){return(0,p.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:m})}},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[4447,6724,5482,580,4800],()=>t(61694));module.exports=o})();