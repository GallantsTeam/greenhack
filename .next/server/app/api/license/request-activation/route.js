"use strict";(()=>{var e={};e.id=238,e.ids=[238],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:e=>{e.exports=require("process")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},84615:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>m,routeModule:()=>_,serverHooks:()=>v,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>c});var a={};r.r(a),r.d(a,{POST:()=>d});var s=r(96559),i=r(48088),o=r(37719),n=r(32190),u=r(75365),p=r(42192);async function d(e){try{let{inventoryItemId:t,userId:r,enteredKey:a}=await e.json();if(console.log("[API RequestActivation] Received:",{inventoryItemId:t,userId:r,enteredKey:a}),!t||!r||!a)return n.NextResponse.json({message:"Не все поля заполнены (ID предмета, ID пользователя, ключ)."},{status:400});let s=await (0,u.P)(`SELECT 
         ui.*,
         p.name as product_name_from_product_table, 
         p.retrieval_modal_intro_text, 
         p.retrieval_modal_antivirus_text, 
         p.retrieval_modal_antivirus_link_text,
         p.retrieval_modal_antivirus_link_url,
         p.retrieval_modal_launcher_text,
         p.retrieval_modal_launcher_link_text,
         p.retrieval_modal_launcher_link_url,
         p.retrieval_modal_key_paste_text,
         p.retrieval_modal_support_text,
         p.retrieval_modal_support_link_text,
         p.retrieval_modal_support_link_url,
         COALESCE(ppo.duration_days, cp.duration_days) as resolved_duration_days
       FROM user_inventory ui
       LEFT JOIN products p ON ui.related_product_id = p.id
       LEFT JOIN product_pricing_options ppo ON ui.product_pricing_option_id = ppo.id
       LEFT JOIN case_prizes cp ON ui.case_prize_id = cp.id
       WHERE ui.id = ? AND ui.user_id = ?`,[t,r]);if(0===s.length)return n.NextResponse.json({message:"Предмет не найден в вашем инвентаре."},{status:404});let i=s[0],o={...i,product_name:i.product_name||i.product_name_from_product_table,is_used:!!i.is_used,duration_days:i.resolved_duration_days?parseInt(i.resolved_duration_days,10):null,activation_status:i.activation_status||"available"};if("available"!==o.activation_status&&"rejected"!==o.activation_status)return n.NextResponse.json({message:`Этот предмет уже ${"pending_admin_approval"===o.activation_status?"ожидает одобрения":"активирован или истек"}.`},{status:400});let d=await (0,u.P)("SELECT id, username FROM users WHERE id = ?",[r]);if(0===d.length)return n.NextResponse.json({message:"Пользователь не найден."},{status:404});let _=d[0];await (0,u.P)("UPDATE user_inventory SET activation_code = ?, activation_status = ?, updated_at = NOW() WHERE id = ?",[a,"pending_admin_approval",t]),console.log(`[API RequestActivation] Inventory item ${t} status updated to pending_admin_approval with key ${a}`);let l={...o,activation_code:a},c=await (0,p.Dp)(l,_);if(!c.success)return console.error("[API RequestActivation] Failed to send Telegram notification to admin for key activation:",c.error),n.NextResponse.json({message:"Запрос на активацию отправлен, но произошла ошибка при уведомлении администратора. Пожалуйста, свяжитесь с поддержкой, если активация не произойдет в ближайшее время.",warning:c.message},{status:207});return console.log("[API RequestActivation] Key activation request sent to admin."),n.NextResponse.json({message:"Запрос на активацию ключа отправлен администратору. Ожидайте подтверждения."})}catch(e){return console.error("[API RequestActivation] Error:",e),n.NextResponse.json({message:`Внутренняя ошибка сервера: ${e.message}`},{status:500})}}let _=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/license/request-activation/route",pathname:"/api/license/request-activation",filename:"route",bundlePath:"app/api/license/request-activation/route"},resolvedPagePath:"/var/www/html/src/app/api/license/request-activation/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:l,workUnitAsyncStorage:c,serverHooks:v}=_;function m(){return(0,o.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:c})}},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4447,6724,5482,580,4800],()=>r(84615));module.exports=a})();